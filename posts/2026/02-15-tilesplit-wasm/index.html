<!doctype html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <title>TileSplit WASM：把 Ultra HDR 圖片切割搬到瀏覽器</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

  <meta property="og:site_name" content="Simply Patrick"/>
  <meta property="og:url" content="https://blog.simplypatrick.com/posts/2026/02-15-tilesplit-wasm/"/>
  <meta property="og:type" content="website"/>
  <meta property="og:image" content="https://lh3.googleusercontent.com/-GqbL2_hPq9Y/UC9brHyHa1I/AAAAAAAAEoY/rGGtCNWe3Vw/s800/patrick.jpg"/>

  <link rel="preload" href="/fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/Julee-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/JustMeAgainDownHere-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/SourceCodePro-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/NotoSansTC-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/bootstrap-toc.css" rel="stylesheet">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<link href="/css/prism.css" rel="stylesheet" />
<link href="/css/blog.css" rel="stylesheet">

<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon" />

  <meta property="og:site_name" content="Simply Patrick"/>
  <meta property="og:url" content="https://blog.simplypatrick.com/posts/2026/02-15-tilesplit-wasm/"/>
  <meta property="og:title" content="TileSplit WASM：把 Ultra HDR 圖片切割搬到瀏覽器"/>
  <meta property="og:type" content="article"/>
  <meta property="og:article:published_time" content="2026-02-15 10:00:00 &#43;0800 &#43;0800"/>
  
  <meta property="og:article:tag" content="rust"/>
  
  <meta property="og:article:tag" content="webassembly"/>
  
  <meta property="og:article:tag" content="wasm"/>
  
  <meta property="og:article:tag" content="ultrahdr"/>
  
  <meta property="og:article:tag" content="image-processing"/>
  
  <meta property="og:article:author" content="Patrick Tsai"/>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container" id="main">
    <div class="row">
      <header role="banner">
  <div class="row">
    <div class="col-md-9">
      <h1 class="banner-title">
        <a href="/">Simply Patrick</a>
        <small class="banner-subtitle">Hopes can always go up, tears can only come down.</small>
      </h1>
    </div>
    <div class="col-md-3 text-right">
      <ul class="social-links list-inline">
        <li><a href="https://twitter.com/PatrickSimply"><i class="fa fa-twitter"></i></a></li>
        <li><a href="https://www.facebook.com/yinghau76"><i class="fa fa-facebook"></i></a></li>
        <li><a href="https://www.linkedin.com/in/yinghau76"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/p47t"><i class="fa fa-github-alt"></i></a></li>
      </ul>
    </div>
  <div>
</header>

      <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/posts/">posts</a>
      <a class="navbar-brand" href="/tils/">TILs</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">categories <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/categories/ai">ai <span class="badge">1</span></a></li>
          
            <li><a href="/categories/ai-assisted">ai-assisted <span class="badge">2</span></a></li>
          
            <li><a href="/categories/blog">blog <span class="badge">3</span></a></li>
          
            <li><a href="/categories/business">business <span class="badge">26</span></a></li>
          
            <li><a href="/categories/career">career <span class="badge">20</span></a></li>
          
            <li><a href="/categories/claude-code">claude-code <span class="badge">1</span></a></li>
          
            <li><a href="/categories/development">development <span class="badge">52</span></a></li>
          
            <li><a href="/categories/ffi">ffi <span class="badge">1</span></a></li>
          
            <li><a href="/categories/game">game <span class="badge">3</span></a></li>
          
            <li><a href="/categories/programming">programming <span class="badge">205</span></a></li>
          
            <li><a href="/categories/rust">rust <span class="badge">1</span></a></li>
          
            <li><a href="/categories/web">web <span class="badge">10</span></a></li>
          
            <li><a href="/categories/%e7%a1%ac%e9%ab%94">硬體 <span class="badge">1</span></a></li>
          
            <li><a href="/categories/%e9%96%8b%e7%99%bc%e5%b7%a5%e5%85%b7">開發工具 <span class="badge">1</span></a></li>
          
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">tags <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/tags/agent">agent <span class="badge">4</span></a></li>
          
            <li><a href="/tags/agile">agile <span class="badge">4</span></a></li>
          
            <li><a href="/tags/ai">ai <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ai-assisted">ai-assisted <span class="badge">13</span></a></li>
          
            <li><a href="/tags/android">android <span class="badge">14</span></a></li>
          
            <li><a href="/tags/async">async <span class="badge">2</span></a></li>
          
            <li><a href="/tags/audio">audio <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ble">ble <span class="badge">1</span></a></li>
          
            <li><a href="/tags/book">book <span class="badge">25</span></a></li>
          
            <li><a href="/tags/build">build <span class="badge">4</span></a></li>
          
            <li><a href="/tags/build-tools">build-tools <span class="badge">1</span></a></li>
          
            <li><a href="/tags/builder">builder <span class="badge">1</span></a></li>
          
            <li><a href="/tags/c&#43;&#43;">c&#43;&#43; <span class="badge">8</span></a></li>
          
            <li><a href="/tags/cargo-apk">cargo-apk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/claude">claude <span class="badge">1</span></a></li>
          
            <li><a href="/tags/claude-code">claude-code <span class="badge">4</span></a></li>
          
            <li><a href="/tags/cli">cli <span class="badge">2</span></a></li>
          
            <li><a href="/tags/cloud">cloud <span class="badge">1</span></a></li>
          
            <li><a href="/tags/codex">codex <span class="badge">1</span></a></li>
          
            <li><a href="/tags/crack">crack <span class="badge">2</span></a></li>
          
            <li><a href="/tags/derive">derive <span class="badge">1</span></a></li>
          
            <li><a href="/tags/design-patterns">design-patterns <span class="badge">4</span></a></li>
          
            <li><a href="/tags/dotnet">dotnet <span class="badge">42</span></a></li>
          
            <li><a href="/tags/dsp">dsp <span class="badge">1</span></a></li>
          
            <li><a href="/tags/embedded">embedded <span class="badge">5</span></a></li>
          
            <li><a href="/tags/engineer">engineer <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ffi">ffi <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ffmpeg">ffmpeg <span class="badge">1</span></a></li>
          
            <li><a href="/tags/font">font <span class="badge">3</span></a></li>
          
            <li><a href="/tags/fuchsia">fuchsia <span class="badge">2</span></a></li>
          
            <li><a href="/tags/futures">futures <span class="badge">2</span></a></li>
          
            <li><a href="/tags/game">game <span class="badge">2</span></a></li>
          
            <li><a href="/tags/git">git <span class="badge">5</span></a></li>
          
            <li><a href="/tags/go">go <span class="badge">5</span></a></li>
          
            <li><a href="/tags/google">google <span class="badge">5</span></a></li>
          
            <li><a href="/tags/gpu">gpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/gpui">gpui <span class="badge">2</span></a></li>
          
            <li><a href="/tags/gradle">gradle <span class="badge">1</span></a></li>
          
            <li><a href="/tags/gui">gui <span class="badge">4</span></a></li>
          
            <li><a href="/tags/hdr">hdr <span class="badge">1</span></a></li>
          
            <li><a href="/tags/iced">iced <span class="badge">2</span></a></li>
          
            <li><a href="/tags/image-processing">image-processing <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ios">ios <span class="badge">6</span></a></li>
          
            <li><a href="/tags/java">java <span class="badge">9</span></a></li>
          
            <li><a href="/tags/jpeg">jpeg <span class="badge">1</span></a></li>
          
            <li><a href="/tags/jupyter">jupyter <span class="badge">1</span></a></li>
          
            <li><a href="/tags/keyboard">keyboard <span class="badge">1</span></a></li>
          
            <li><a href="/tags/kotlin">kotlin <span class="badge">2</span></a></li>
          
            <li><a href="/tags/kuso">kuso <span class="badge">3</span></a></li>
          
            <li><a href="/tags/management">management <span class="badge">3</span></a></li>
          
            <li><a href="/tags/markdown">markdown <span class="badge">1</span></a></li>
          
            <li><a href="/tags/mechanical-keyboard">mechanical-keyboard <span class="badge">1</span></a></li>
          
            <li><a href="/tags/microsoft">microsoft <span class="badge">14</span></a></li>
          
            <li><a href="/tags/ndk">ndk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/octopress">octopress <span class="badge">3</span></a></li>
          
            <li><a href="/tags/ortholinear">ortholinear <span class="badge">1</span></a></li>
          
            <li><a href="/tags/osx">osx <span class="badge">4</span></a></li>
          
            <li><a href="/tags/parser">parser <span class="badge">1</span></a></li>
          
            <li><a href="/tags/patterns">patterns <span class="badge">4</span></a></li>
          
            <li><a href="/tags/peacock">peacock <span class="badge">1</span></a></li>
          
            <li><a href="/tags/proc-macro">proc-macro <span class="badge">1</span></a></li>
          
            <li><a href="/tags/process">process <span class="badge">2</span></a></li>
          
            <li><a href="/tags/productivity">productivity <span class="badge">1</span></a></li>
          
            <li><a href="/tags/qmk">qmk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ruby">ruby <span class="badge">15</span></a></li>
          
            <li><a href="/tags/rust">rust <span class="badge">23</span></a></li>
          
            <li><a href="/tags/scala">scala <span class="badge">3</span></a></li>
          
            <li><a href="/tags/shader">shader <span class="badge">1</span></a></li>
          
            <li><a href="/tags/slint">slint <span class="badge">1</span></a></li>
          
            <li><a href="/tags/spaced-repetition">spaced-repetition <span class="badge">1</span></a></li>
          
            <li><a href="/tags/startup">startup <span class="badge">3</span></a></li>
          
            <li><a href="/tags/swift">swift <span class="badge">1</span></a></li>
          
            <li><a href="/tags/traits">traits <span class="badge">1</span></a></li>
          
            <li><a href="/tags/tui">tui <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ultrahdr">ultrahdr <span class="badge">2</span></a></li>
          
            <li><a href="/tags/vcs">vcs <span class="badge">3</span></a></li>
          
            <li><a href="/tags/vibe-coding">vibe-coding <span class="badge">1</span></a></li>
          
            <li><a href="/tags/vscode">vscode <span class="badge">1</span></a></li>
          
            <li><a href="/tags/wasm">wasm <span class="badge">5</span></a></li>
          
            <li><a href="/tags/web">web <span class="badge">3</span></a></li>
          
            <li><a href="/tags/webassembly">webassembly <span class="badge">3</span></a></li>
          
            <li><a href="/tags/webgpu">webgpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/webkit">webkit <span class="badge">3</span></a></li>
          
            <li><a href="/tags/wgpu">wgpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/windows">windows <span class="badge">5</span></a></li>
          
            <li><a href="/tags/work">work <span class="badge">11</span></a></li>
          
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">series <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/series/fuchsia-dev">fuchsia dev <span class="badge">2</span></a></li>
          
            <li><a href="/series/modern-c&#43;&#43;">modern c&#43;&#43; <span class="badge">2</span></a></li>
          
            <li><a href="/series/rust-52-projects">rust-52-projects <span class="badge">11</span></a></li>
          
            <li><a href="/series/zeroclaw">zeroclaw <span class="badge">4</span></a></li>
          
          </ul>
        </li>
      </ul>
      <form class="navbar-form navbar-left" role="search" action="/search/" method="get">
        <div class="form-group">
          <input class="form-control" type="text" name="q" results="0" placeholder="search"/>
        </div>
        <button type="submit" class="btn btn-default">submit</button>
      </form>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/pages/about">about</a></li>
      </ul>
    </div>
  </div>
</nav>

    </div>

  <div class="row">
    <div class="col-md-9" data-pagefind-body>
          <div class="row">
      <div class="col-xs-6">
        
        <section id="prev" class="text-left">
          <a class="previous" href="https://blog.simplypatrick.com/posts/2026/02-14-tilesplit/">
            <span class="glyphicon glyphicon-circle-arrow-left"></span>
            TileSplit：用 Rust 打造保留 Ultra HDR 資訊的圖片切割工具
          </a>
        </section>
        
      </div>
      <div class="col-xs-6">
        
        <section id="next" class="text-right">
          <a class="next" href="https://blog.simplypatrick.com/posts/2026/02-18-media-metadata-explorer/">
            Rust 媒體元資料探索器：用 FFmpeg 剖析影音檔案與打造 TUI
            <span class="glyphicon glyphicon-circle-arrow-right"></span>
          </a>
        </section>
        
      </div>
    </div>
      <h2 class="post-title">TileSplit WASM：把 Ultra HDR 圖片切割搬到瀏覽器</h2>
      <div class="post-meta">
        <span class="post-date">February 15, 2026</span>
        
        <a href="/categories/programming"><span class="label label-info">programming</span></a>
        
        
        <a href="/tags/rust"><span class="label label-primary">rust</span></a>
        
        <a href="/tags/webassembly"><span class="label label-primary">webassembly</span></a>
        
        <a href="/tags/wasm"><span class="label label-primary">wasm</span></a>
        
        <a href="/tags/ultrahdr"><span class="label label-primary">ultrahdr</span></a>
        
        <a href="/tags/image-processing"><span class="label label-primary">image-processing</span></a>
        
        
<div>
  
  <hr/>
  <p>
    <a href="" id="series"></a>
    這篇文章屬於 <b>rust-52-projects</b> 系列:
  </p>

  
  
  <ul class="series">
  
    <li>Feb 18, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-18-media-metadata-explorer/">Rust 媒體元資料探索器：用 FFmpeg 剖析影音檔案與打造 TUI</a></li>
  
    <li>Feb 15, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-15-tilesplit-wasm/">TileSplit WASM：把 Ultra HDR 圖片切割搬到瀏覽器</a></li>
  
    <li>Feb 14, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-14-tilesplit/">TileSplit：用 Rust 打造保留 Ultra HDR 資訊的圖片切割工具</a></li>
  
    <li>Feb 13, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-13-rust-proc-macro-builder-derive/">Rust Proc Macro：builder-derive 實戰</a></li>
  
    <li>Feb 09, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-09-wgpu-game-of-life/">用 Rust &#43; WebGPU 在瀏覽器跑 Game of Life</a></li>
  
    <li>Feb 08, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-09-cargo-apk/">深入理解 cargo-apk：從 Rust 到 Android APK 的完整流程</a></li>
  
    <li>Feb 08, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-08-flashcard-app/">從間隔重複記憶卡學習 Rust 程式設計</a></li>
  
    <li>Feb 07, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-07-guitar-fretboard/">從吉他指板視覺化學習 Rust 程式設計</a></li>
  
    <li>Jan 31, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-31-gpui-calculator/">從 GPUI 計算機學習 Rust 程式設計</a></li>
  
    <li>Jan 06, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-06-rust-wasm-markdown-editor/">用 Rust 和 WebAssembly 打造即時 Markdown 編輯器</a></li>
  
    <li>Jan 03, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-03-async-job-queue/">使用 Rust 實作非同步任務佇列：系統設計與核心概念</a></li>
  
  </ul>
</div>


      </div>
      <div class="post-content">
        <p><a href="/posts/2026/02-14-tilesplit/">上一篇</a>介紹了 <code>tilesplit</code> CLI，一個用 Rust 寫的工具，可以在切割圖片的同時保留 Ultra HDR 資訊。但要用 CLI 切個照片還得先裝 Rust 工具鏈&hellip; 不如直接在瀏覽器裡搞定？</p>
<p>這篇就來聊聊怎麼把 <code>tilesplit</code> 移植到 WebAssembly，讓任何人<a href="https://blog.simplypatrick.com/demos/tilesplit/">打開網頁</a>就能用。</p>
<h2 id="先玩再說">先玩再說</h2>
<iframe src="/demos/tilesplit/" style="width: 100%; height: 730px; border: 1px solid #333; border-radius: 8px; background: #0f1117;" loading="lazy"></iframe>
<blockquote>
<p><strong>使用方式</strong>：拖一張 JPEG 進去（支援 3:2 或 16:10 比例），調整品質後按 Split。如果是 Ultra HDR 照片，會自動偵測並顯示 HDR 標籤。切完的圖可以直接下載。</p>
</blockquote>
<h2 id="從-cli-到-wasm關鍵差異">從 CLI 到 WASM：關鍵差異</h2>
<p>把 <code>tilesplit</code> 搬到瀏覽器不是改個編譯目標就完事的。最大的挑戰在於<strong>依賴庫的替換</strong>。</p>
<p>CLI 版本用了兩個 C/C++ FFI 的 crate：</p>
<ul>
<li><strong><code>ultrahdr-rs</code></strong>：Google <code>libultrahdr</code> 的封裝，處理 Ultra HDR 的編解碼和容器組裝</li>
<li><strong><code>jpegli-rs</code></strong>：Google <code>jpegli</code> 的封裝，高品質 JPEG 編解碼器，支援讀寫 Gain Map</li>
</ul>
<p>問題是：<strong>WASM 沒辦法呼叫 C FFI</strong>。這兩個 crate 都需要編譯 C/C++ 原始碼，在 <code>wasm32-unknown-unknown</code> 目標下根本編不過。</p>
<p>WASM 版本的替代方案：</p>
<table>
  <thead>
      <tr>
          <th>功能</th>
          <th>CLI 版本</th>
          <th>WASM 版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>JPEG 編解碼</td>
          <td><code>jpegli-rs</code> (C FFI)</td>
          <td><code>image</code> crate (純 Rust)</td>
      </tr>
      <tr>
          <td>Ultra HDR metadata</td>
          <td><code>ultrahdr-rs</code> (C FFI)</td>
          <td><code>ultrahdr-core</code> (純 Rust)</td>
      </tr>
      <tr>
          <td>容器組裝</td>
          <td><code>ultrahdr-rs</code> 的 <code>add_gainmap()</code></td>
          <td>手動組裝 MPF 格式</td>
      </tr>
  </tbody>
</table>
<p><a href="https://crates.io/crates/ultrahdr-core"><code>ultrahdr-core</code></a> 是個輕量的純 Rust crate，只做 metadata 解析和 XMP 生成，不碰任何 C 程式碼——正好適合 WASM。而 <a href="https://crates.io/crates/image"><code>image</code></a> crate 的 JPEG 功能雖然沒有 <code>jpegli</code> 那麼強，但對我們的需求來說夠用了。</p>
<p>最麻煩的是容器組裝。CLI 版本靠 <code>jpegli-rs</code> 的 <code>.add_gainmap()</code> 一行搞定，但 WASM 版本得自己手動把 XMP marker、MPF header、Gain Map JPEG 按照正確的格式塞回主圖裡。這部分後面會詳細說明。</p>
<h2 id="wasm-api-設計">WASM API 設計</h2>
<p>WASM 模組只暴露三個函式給 JavaScript：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[wasm_bindgen]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">validate_image</span>(data: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>]) -&gt; Result<span style="color:#f92672">&lt;</span>JsValue, JsValue<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    console_error_panic_hook::set_once();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> img <span style="color:#f92672">=</span> image::load_from_memory(data)
</span></span><span style="display:flex;"><span>        .map_err(<span style="color:#f92672">|</span>e<span style="color:#f92672">|</span> JsValue::from_str(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">format!</span>(<span style="color:#e6db74">&#34;Failed to decode image: </span><span style="color:#e6db74">{e}</span><span style="color:#e6db74">&#34;</span>)))<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> (width, height) <span style="color:#f92672">=</span> (img.width(), img.height());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> is_ultra_hdr <span style="color:#f92672">=</span> detect_ultrahdr(data).is_some();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> (left, _) <span style="color:#f92672">=</span> compute_split_rectangles(width, height)
</span></span><span style="display:flex;"><span>        .map_err(<span style="color:#f92672">|</span>e<span style="color:#f92672">|</span> JsValue::from_str(<span style="color:#f92672">&amp;</span>e))<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> info <span style="color:#f92672">=</span> ImageInfo { width, height, <span style="color:#75715e">/* ... */</span> };
</span></span><span style="display:flex;"><span>    serde_wasm_bindgen::to_value(<span style="color:#f92672">&amp;</span>info)
</span></span><span style="display:flex;"><span>        .map_err(<span style="color:#f92672">|</span>e<span style="color:#f92672">|</span> JsValue::from_str(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">format!</span>(<span style="color:#e6db74">&#34;Serialization error: </span><span style="color:#e6db74">{e}</span><span style="color:#e6db74">&#34;</span>)))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[wasm_bindgen]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">split_left</span>(data: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>], quality: <span style="color:#66d9ef">u8</span>) -&gt; Result<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>, JsValue<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    console_error_panic_hook::set_once();
</span></span><span style="display:flex;"><span>    split_tile(data, quality, Side::Left).map_err(<span style="color:#f92672">|</span>e<span style="color:#f92672">|</span> JsValue::from_str(<span style="color:#f92672">&amp;</span>e))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[wasm_bindgen]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">split_right</span>(data: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>], quality: <span style="color:#66d9ef">u8</span>) -&gt; Result<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>, JsValue<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    console_error_panic_hook::set_once();
</span></span><span style="display:flex;"><span>    split_tile(data, quality, Side::Right).map_err(<span style="color:#f92672">|</span>e<span style="color:#f92672">|</span> JsValue::from_str(<span style="color:#f92672">&amp;</span>e))
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>回傳給 JS 的 <code>ImageInfo</code> 用 <code>serde</code> 序列化成 JS object：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Serialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ImageInfo</span> {
</span></span><span style="display:flex;"><span>    width: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>    height: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>    aspect: String,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[serde(rename = </span><span style="color:#e6db74">&#34;isUltraHdr&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>    is_ultra_hdr: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[serde(rename = </span><span style="color:#e6db74">&#34;tileWidth&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>    tile_width: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[serde(rename = </span><span style="color:#e6db74">&#34;tileHeight&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>    tile_height: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>資料流很直覺：JS 透過 <code>FileReader</code> 讀取使用者選的檔案，轉成 <code>Uint8Array</code> 傳進 WASM，WASM 處理完回傳 <code>Vec&lt;u8&gt;</code>（自動轉成 <code>Uint8Array</code>），JS 再包成 Blob URL 給 <code>&lt;img&gt;</code> 顯示和下載。</p>
<h2 id="ultra-hdr-偵測">Ultra HDR 偵測</h2>
<p>WASM 版本的 Ultra HDR 偵測是直接解析 JPEG 的二進制結構，不靠任何外部庫的 JPEG 解碼器：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">detect_ultrahdr</span>(data: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>]) -&gt; Option<span style="color:#f92672">&lt;</span>UltraHdrData<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. 從 JPEG 的 APP1 marker 裡撈出 XMP metadata
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> xmp <span style="color:#f92672">=</span> extract_xmp_from_jpeg_bytes(data)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. 解析 XMP 得到 GainMapMetadata
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> (<span style="color:#66d9ef">mut</span> metadata, _) <span style="color:#f92672">=</span> ultrahdr_core::metadata::xmp::parse_xmp(<span style="color:#f92672">&amp;</span>xmp).ok()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. 從 MPF (Multi-Picture Format) 裡提取 Gain Map JPEG
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> gainmap_jpeg <span style="color:#f92672">=</span> extract_gainmap_from_mpf(data)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 主圖的 metadata 可能不完整，試試從 Gain Map 自己的 XMP 補齊
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> metadata_looks_default_or_incomplete(<span style="color:#f92672">&amp;</span>metadata) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(gm_xmp) <span style="color:#f92672">=</span> extract_xmp_from_jpeg_bytes(<span style="color:#f92672">&amp;</span>gainmap_jpeg) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Ok((<span style="color:#66d9ef">mut</span> gm_meta, _)) <span style="color:#f92672">=</span> ultrahdr_core::metadata::xmp::parse_xmp(<span style="color:#f92672">&amp;</span>gm_xmp) {
</span></span><span style="display:flex;"><span>                apply_lenient_xmp_overrides(<span style="color:#f92672">&amp;</span>gm_xmp, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> gm_meta);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>metadata_looks_default_or_incomplete(<span style="color:#f92672">&amp;</span>gm_meta) {
</span></span><span style="display:flex;"><span>                    metadata <span style="color:#f92672">=</span> gm_meta;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    apply_lenient_xmp_overrides(<span style="color:#f92672">&amp;</span>xmp, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> metadata);
</span></span><span style="display:flex;"><span>    Some(UltraHdrData { metadata, gainmap_jpeg })
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>跟 CLI 版本比起來，最大的差異是 XMP 提取。CLI 版本靠 <code>jpegli</code> 解碼器順便把 XMP 和 Gain Map 從 JPEG extras 裡讀出來。WASM 版本沒有 <code>jpegli</code>，只好自己掃描 JPEG marker——找 <code>0xFFE1</code> (APP1) 拿 XMP，再用 <code>ultrahdr-core</code> 的 MPF parser 找 Gain Map 的位置。</p>
<h2 id="手動組裝-ultra-hdr-容器">手動組裝 Ultra HDR 容器</h2>
<p>這是 WASM 移植裡最複雜的部分。CLI 版本一行 <code>.add_gainmap()</code> 就搞定的事，在 WASM 版本得手動處理 MPF (Multi-Picture Format) 的二進制結構。</p>
<p>一張 Ultra HDR JPEG 的結構大概長這樣：</p>

  <pre tabindex="0"><code>┌─────────────────────────────────┐
│ SOI (0xFFD8)                    │
│ APP1 - XMP metadata             │  ← 告訴系統「我是 Ultra HDR」
│ APP2 - MPF header               │  ← 告訴系統「Gain Map 在哪裡」
│ ... 正常的 JPEG 資料 ...         │
│ EOI (0xFFD9)                    │
├─────────────────────────────────┤
│ Gain Map JPEG (完整的第二張圖)   │  ← 亮度增益資訊
└─────────────────────────────────┘</code></pre>

<p><code>assemble_ultrahdr_tile</code> 函式負責把這些東西拼在一起：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">assemble_ultrahdr_tile</span>(
</span></span><span style="display:flex;"><span>    sdr_jpeg: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>],
</span></span><span style="display:flex;"><span>    gainmap_jpeg: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>],
</span></span><span style="display:flex;"><span>    metadata: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">GainMapMetadata</span>,
</span></span><span style="display:flex;"><span>) -&gt; Result<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>, String<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. 在 Gain Map JPEG 裡嵌入 XMP metadata
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> gainmap_xmp <span style="color:#f92672">=</span> generate_gainmap_xmp(metadata);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> gainmap_jpeg_with_xmp <span style="color:#f92672">=</span> embed_xmp_in_jpeg(gainmap_jpeg, <span style="color:#f92672">&amp;</span>gainmap_xmp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. 產生主圖的 XMP APP1 marker（包含完整參數 + Container directory）
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> xmp <span style="color:#f92672">=</span> generate_primary_xmp(metadata, gainmap_jpeg_with_xmp.len());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> xmp_marker <span style="color:#f92672">=</span> ultrahdr_core::metadata::xmp::create_xmp_app1_marker(<span style="color:#f92672">&amp;</span>xmp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. 把 XMP 插到 SOI 後面
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> primary_with_xmp <span style="color:#f92672">=</span> Vec::with_capacity(sdr_jpeg.len() <span style="color:#f92672">+</span> xmp_marker.len());
</span></span><span style="display:flex;"><span>    primary_with_xmp.extend_from_slice(<span style="color:#f92672">&amp;</span>sdr_jpeg[<span style="color:#f92672">..</span><span style="color:#ae81ff">2</span>]); <span style="color:#75715e">// SOI
</span></span></span><span style="display:flex;"><span>    primary_with_xmp.extend_from_slice(<span style="color:#f92672">&amp;</span>xmp_marker);
</span></span><span style="display:flex;"><span>    primary_with_xmp.extend_from_slice(<span style="color:#f92672">&amp;</span>sdr_jpeg[<span style="color:#ae81ff">2</span><span style="color:#f92672">..</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4. 找到插入 MPF APP2 的位置（在 APP0/APP1 之後）
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> insert_pos <span style="color:#f92672">=</span> find_mpf_insert_position(<span style="color:#f92672">&amp;</span>primary_with_xmp)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 5. 計算 MPF header（需要知道最終的 primary 大小，所以先算一次）
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> gm_len <span style="color:#f92672">=</span> gainmap_jpeg_with_xmp.len() <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u32</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> placeholder_mpf <span style="color:#f92672">=</span> create_mpf_app2(<span style="color:#66d9ef">u32</span>::<span style="color:#66d9ef">MAX</span>, <span style="color:#f92672">&amp;</span>[gm_len], insert_pos);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> primary_final_size <span style="color:#f92672">=</span> (primary_with_xmp.len() <span style="color:#f92672">+</span> placeholder_mpf.len()) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u32</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> mpf_header <span style="color:#f92672">=</span> create_mpf_app2(primary_final_size, <span style="color:#f92672">&amp;</span>[gm_len], insert_pos);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 6. 組裝最終輸出
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> output <span style="color:#f92672">=</span> Vec::with_capacity(
</span></span><span style="display:flex;"><span>        primary_with_xmp.len() <span style="color:#f92672">+</span> mpf_header.len() <span style="color:#f92672">+</span> gainmap_jpeg_with_xmp.len()
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    output.extend_from_slice(<span style="color:#f92672">&amp;</span>primary_with_xmp[<span style="color:#f92672">..</span>insert_pos]);
</span></span><span style="display:flex;"><span>    output.extend_from_slice(<span style="color:#f92672">&amp;</span>mpf_header);
</span></span><span style="display:flex;"><span>    output.extend_from_slice(<span style="color:#f92672">&amp;</span>primary_with_xmp[insert_pos<span style="color:#f92672">..</span>]);
</span></span><span style="display:flex;"><span>    output.extend_from_slice(<span style="color:#f92672">&amp;</span>gainmap_jpeg_with_xmp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(output)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>MPF header 裡面是個迷你的 TIFF IFD 結構，記錄了每張圖片的大小和偏移量。這裡有個雞生蛋的問題：MPF header 裡需要填 primary 的最終大小，但 primary 的大小又取決於 MPF header 有多大。解法是先用 placeholder 算出 MPF 的固定大小，再用正確的數值重新生成。</p>
<h2 id="wasm-體積優化">WASM 體積優化</h2>
<p>WASM 版本最終編出來的 <code>.wasm</code> 檔案大約 <strong>286 KB</strong>，對一個包含完整 JPEG 編解碼和 Ultra HDR 處理的模組來說算很小了。主要靠幾個手段：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">release</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">opt-level</span> = <span style="color:#e6db74">&#34;s&#34;</span>   <span style="color:#75715e"># 優化體積而非速度</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lto</span> = <span style="color:#66d9ef">true</span>         <span style="color:#75715e"># 跨 crate 的 Link-Time Optimization</span></span></span></code></pre></div>

<p>加上 <code>image</code> crate 只啟用 <code>jpeg</code> feature，不拉進 PNG、GIF 等不需要的格式：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">dependencies</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">image</span> = { <span style="color:#a6e22e">version</span> = <span style="color:#e6db74">&#34;0.25.5&#34;</span>, <span style="color:#a6e22e">default-features</span> = <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">features</span> = [<span style="color:#e6db74">&#34;jpeg&#34;</span>] }</span></span></code></pre></div>

<p><code>default-features = false</code> 很重要——<code>image</code> crate 預設會拉進一大堆圖片格式的支援，對 WASM 體積影響很大。</p>
<h2 id="js-端的整合">JS 端的整合</h2>
<p>前端部分很簡單，用原生的 ES module 載入 WASM：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">init</span>, { <span style="color:#a6e22e">validate_image</span>, <span style="color:#a6e22e">split_left</span>, <span style="color:#a6e22e">split_right</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./tilesplit_wasm.js&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">init</span>();  <span style="color:#75715e">// 載入並初始化 WASM 模組
</span></span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;TileSplit WASM loaded&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">run</span>();</span></span></code></pre></div>

<p><code>wasm-pack build --target web</code> 產生的 JS glue code 會自動處理 WASM 的載入和記憶體管理。<code>init()</code> 內部用 <code>WebAssembly.instantiateStreaming</code> 做串流載入，瀏覽器可以在下載 WASM 的同時開始編譯，體驗很流暢。</p>
<p>圖片處理的流程：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// 使用者選擇檔案後
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reader</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileReader</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">e</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">result</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">info</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validate_image</span>(<span style="color:#a6e22e">data</span>);  <span style="color:#75715e">// WASM 驗證
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 顯示圖片資訊...
</span></span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">readAsArrayBuffer</span>(<span style="color:#a6e22e">file</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 按下 Split 後
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">leftBytes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">split_left</span>(<span style="color:#a6e22e">currentData</span>, <span style="color:#a6e22e">quality</span>);   <span style="color:#75715e">// WASM 切割
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rightBytes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">split_right</span>(<span style="color:#a6e22e">currentData</span>, <span style="color:#a6e22e">quality</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">leftBlob</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Blob</span>([<span style="color:#a6e22e">leftBytes</span>], { <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;image/jpeg&#39;</span> });
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">previewLeft</span>.<span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">createObjectURL</span>(<span style="color:#a6e22e">leftBlob</span>);       <span style="color:#75715e">// 顯示預覽
</span></span></span></code></pre></div>

<p>整個過程都在瀏覽器本地完成，圖片不會上傳到任何伺服器。</p>
<h3 id="小結">小結</h3>
<p>Ultra HDR 的「正確」其實散落在規格的各個角落。光看 <a href="https://www.iso.org/standard/81379.html">ISO 21496-1</a> 規格書不夠，得拿 Lightroom、Google Photos 等軟體的實際輸出來對照，才能確定哪些欄位是必要的、viewer 實際上怎麼解析。</p>
<h2 id="結語">結語</h2>
<p>把 Rust CLI 工具移植到 WASM 最大的收穫是：<strong>降低了使用門檻</strong>。不需要安裝任何東西，打開網頁就能用。對於像 <code>tilesplit</code> 這種偶爾才用一次的小工具，WASM 版本可能比 CLI 更實用。</p>
<p>當然也有取捨——WASM 版本用的 <code>image</code> crate JPEG 編碼器品質沒有 <code>jpegli</code> 好，處理速度也稍慢一些。但對於「切一張照片發 IG」這個使用情境來說，完全夠用。</p>
<p>完整程式碼在 <a href="https://github.com/p47t/rust-52-projects/tree/main/tilesplit-wasm">GitHub</a> 上。</p>

      </div>

      <hr>
      <script src="https://utteranc.es/client.js"
        repo="p47t/p47t.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


    </div>
    <div class="col-md-3">
      <aside class="toc">
        






<nav id="toc" data-toggle="toc">
  
  <ul class="nav">
  </ul>
</nav>

      </aside>
    </div>
  </div>
    </div>

    <div class="row">
    <div class="col-md-12">
      <footer id="footer" class="text-center">
        © Patrick Tsai 2003-2026.
        Proudly powered by <a href="http://gohugo.io/">Hugo</a>.
      </footer>
    </div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="/js/bootstrap-toc.min.js"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73968064-1', 'auto');
  ga('send', 'pageview');

</script>


  <script src="/js/prism.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true });
  </script>

</body>
</html>
