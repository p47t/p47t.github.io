<!doctype html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <title>Rust Proc Macro：builder-derive 實戰</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

  <meta property="og:site_name" content="Simply Patrick"/>
  <meta property="og:url" content="https://blog.simplypatrick.com/posts/2026/02-13-rust-proc-macro-builder-derive/"/>
  <meta property="og:type" content="website"/>
  <meta property="og:image" content="https://lh3.googleusercontent.com/-GqbL2_hPq9Y/UC9brHyHa1I/AAAAAAAAEoY/rGGtCNWe3Vw/s800/patrick.jpg"/>

  <link rel="preload" href="/fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/Julee-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/JustMeAgainDownHere-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/SourceCodePro-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/NotoSansTC-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/bootstrap-toc.css" rel="stylesheet">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<link href="/css/prism.css" rel="stylesheet" />
<link href="/css/blog.css" rel="stylesheet">

<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon" />

  <meta property="og:site_name" content="Simply Patrick"/>
  <meta property="og:url" content="https://blog.simplypatrick.com/posts/2026/02-13-rust-proc-macro-builder-derive/"/>
  <meta property="og:title" content="Rust Proc Macro：builder-derive 實戰"/>
  <meta property="og:type" content="article"/>
  <meta property="og:article:published_time" content="2026-02-13 00:00:00 -0800 -0800"/>
  
  <meta property="og:article:tag" content="rust"/>
  
  <meta property="og:article:tag" content="proc-macro"/>
  
  <meta property="og:article:tag" content="derive"/>
  
  <meta property="og:article:tag" content="builder"/>
  
  <meta property="og:article:tag" content="ai-assisted"/>
  
  <meta property="og:article:tag" content="codex"/>
  
  <meta property="og:article:author" content="Patrick Tsai"/>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container" id="main">
    <div class="row">
      <header role="banner">
  <div class="row">
    <div class="col-md-9">
      <h1 class="banner-title">
        <a href="/">Simply Patrick</a>
        <small class="banner-subtitle">Hopes can always go up, tears can only come down.</small>
      </h1>
    </div>
    <div class="col-md-3 text-right">
      <ul class="social-links list-inline">
        <li><a href="https://twitter.com/PatrickSimply"><i class="fa fa-twitter"></i></a></li>
        <li><a href="https://www.facebook.com/yinghau76"><i class="fa fa-facebook"></i></a></li>
        <li><a href="https://www.linkedin.com/in/yinghau76"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/p47t"><i class="fa fa-github-alt"></i></a></li>
      </ul>
    </div>
  <div>
</header>

      <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/posts/">posts</a>
      <a class="navbar-brand" href="/tils/">TILs</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">categories <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/categories/ai">ai <span class="badge">1</span></a></li>
          
            <li><a href="/categories/ai-assisted">ai-assisted <span class="badge">2</span></a></li>
          
            <li><a href="/categories/blog">blog <span class="badge">3</span></a></li>
          
            <li><a href="/categories/business">business <span class="badge">26</span></a></li>
          
            <li><a href="/categories/career">career <span class="badge">20</span></a></li>
          
            <li><a href="/categories/claude-code">claude-code <span class="badge">1</span></a></li>
          
            <li><a href="/categories/development">development <span class="badge">52</span></a></li>
          
            <li><a href="/categories/ffi">ffi <span class="badge">1</span></a></li>
          
            <li><a href="/categories/game">game <span class="badge">3</span></a></li>
          
            <li><a href="/categories/programming">programming <span class="badge">205</span></a></li>
          
            <li><a href="/categories/rust">rust <span class="badge">1</span></a></li>
          
            <li><a href="/categories/web">web <span class="badge">10</span></a></li>
          
            <li><a href="/categories/%e7%a1%ac%e9%ab%94">硬體 <span class="badge">1</span></a></li>
          
            <li><a href="/categories/%e9%96%8b%e7%99%bc%e5%b7%a5%e5%85%b7">開發工具 <span class="badge">1</span></a></li>
          
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">tags <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/tags/agent">agent <span class="badge">4</span></a></li>
          
            <li><a href="/tags/agile">agile <span class="badge">4</span></a></li>
          
            <li><a href="/tags/ai">ai <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ai-assisted">ai-assisted <span class="badge">13</span></a></li>
          
            <li><a href="/tags/android">android <span class="badge">14</span></a></li>
          
            <li><a href="/tags/async">async <span class="badge">2</span></a></li>
          
            <li><a href="/tags/audio">audio <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ble">ble <span class="badge">1</span></a></li>
          
            <li><a href="/tags/book">book <span class="badge">25</span></a></li>
          
            <li><a href="/tags/build">build <span class="badge">4</span></a></li>
          
            <li><a href="/tags/build-tools">build-tools <span class="badge">1</span></a></li>
          
            <li><a href="/tags/builder">builder <span class="badge">1</span></a></li>
          
            <li><a href="/tags/c&#43;&#43;">c&#43;&#43; <span class="badge">8</span></a></li>
          
            <li><a href="/tags/cargo-apk">cargo-apk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/claude">claude <span class="badge">1</span></a></li>
          
            <li><a href="/tags/claude-code">claude-code <span class="badge">4</span></a></li>
          
            <li><a href="/tags/cli">cli <span class="badge">2</span></a></li>
          
            <li><a href="/tags/cloud">cloud <span class="badge">1</span></a></li>
          
            <li><a href="/tags/codex">codex <span class="badge">1</span></a></li>
          
            <li><a href="/tags/crack">crack <span class="badge">2</span></a></li>
          
            <li><a href="/tags/derive">derive <span class="badge">1</span></a></li>
          
            <li><a href="/tags/design-patterns">design-patterns <span class="badge">4</span></a></li>
          
            <li><a href="/tags/dotnet">dotnet <span class="badge">42</span></a></li>
          
            <li><a href="/tags/dsp">dsp <span class="badge">1</span></a></li>
          
            <li><a href="/tags/embedded">embedded <span class="badge">5</span></a></li>
          
            <li><a href="/tags/engineer">engineer <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ffi">ffi <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ffmpeg">ffmpeg <span class="badge">1</span></a></li>
          
            <li><a href="/tags/font">font <span class="badge">3</span></a></li>
          
            <li><a href="/tags/fuchsia">fuchsia <span class="badge">2</span></a></li>
          
            <li><a href="/tags/futures">futures <span class="badge">2</span></a></li>
          
            <li><a href="/tags/game">game <span class="badge">2</span></a></li>
          
            <li><a href="/tags/git">git <span class="badge">5</span></a></li>
          
            <li><a href="/tags/go">go <span class="badge">5</span></a></li>
          
            <li><a href="/tags/google">google <span class="badge">5</span></a></li>
          
            <li><a href="/tags/gpu">gpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/gpui">gpui <span class="badge">2</span></a></li>
          
            <li><a href="/tags/gradle">gradle <span class="badge">1</span></a></li>
          
            <li><a href="/tags/gui">gui <span class="badge">4</span></a></li>
          
            <li><a href="/tags/hdr">hdr <span class="badge">1</span></a></li>
          
            <li><a href="/tags/iced">iced <span class="badge">2</span></a></li>
          
            <li><a href="/tags/image-processing">image-processing <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ios">ios <span class="badge">6</span></a></li>
          
            <li><a href="/tags/java">java <span class="badge">9</span></a></li>
          
            <li><a href="/tags/jpeg">jpeg <span class="badge">1</span></a></li>
          
            <li><a href="/tags/jupyter">jupyter <span class="badge">1</span></a></li>
          
            <li><a href="/tags/keyboard">keyboard <span class="badge">1</span></a></li>
          
            <li><a href="/tags/kotlin">kotlin <span class="badge">2</span></a></li>
          
            <li><a href="/tags/kuso">kuso <span class="badge">3</span></a></li>
          
            <li><a href="/tags/management">management <span class="badge">3</span></a></li>
          
            <li><a href="/tags/markdown">markdown <span class="badge">1</span></a></li>
          
            <li><a href="/tags/mechanical-keyboard">mechanical-keyboard <span class="badge">1</span></a></li>
          
            <li><a href="/tags/microsoft">microsoft <span class="badge">14</span></a></li>
          
            <li><a href="/tags/ndk">ndk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/octopress">octopress <span class="badge">3</span></a></li>
          
            <li><a href="/tags/ortholinear">ortholinear <span class="badge">1</span></a></li>
          
            <li><a href="/tags/osx">osx <span class="badge">4</span></a></li>
          
            <li><a href="/tags/parser">parser <span class="badge">1</span></a></li>
          
            <li><a href="/tags/patterns">patterns <span class="badge">4</span></a></li>
          
            <li><a href="/tags/peacock">peacock <span class="badge">1</span></a></li>
          
            <li><a href="/tags/proc-macro">proc-macro <span class="badge">1</span></a></li>
          
            <li><a href="/tags/process">process <span class="badge">2</span></a></li>
          
            <li><a href="/tags/productivity">productivity <span class="badge">1</span></a></li>
          
            <li><a href="/tags/qmk">qmk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ruby">ruby <span class="badge">15</span></a></li>
          
            <li><a href="/tags/rust">rust <span class="badge">23</span></a></li>
          
            <li><a href="/tags/scala">scala <span class="badge">3</span></a></li>
          
            <li><a href="/tags/shader">shader <span class="badge">1</span></a></li>
          
            <li><a href="/tags/slint">slint <span class="badge">1</span></a></li>
          
            <li><a href="/tags/spaced-repetition">spaced-repetition <span class="badge">1</span></a></li>
          
            <li><a href="/tags/startup">startup <span class="badge">3</span></a></li>
          
            <li><a href="/tags/swift">swift <span class="badge">1</span></a></li>
          
            <li><a href="/tags/traits">traits <span class="badge">1</span></a></li>
          
            <li><a href="/tags/tui">tui <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ultrahdr">ultrahdr <span class="badge">2</span></a></li>
          
            <li><a href="/tags/vcs">vcs <span class="badge">3</span></a></li>
          
            <li><a href="/tags/vibe-coding">vibe-coding <span class="badge">1</span></a></li>
          
            <li><a href="/tags/vscode">vscode <span class="badge">1</span></a></li>
          
            <li><a href="/tags/wasm">wasm <span class="badge">5</span></a></li>
          
            <li><a href="/tags/web">web <span class="badge">3</span></a></li>
          
            <li><a href="/tags/webassembly">webassembly <span class="badge">3</span></a></li>
          
            <li><a href="/tags/webgpu">webgpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/webkit">webkit <span class="badge">3</span></a></li>
          
            <li><a href="/tags/wgpu">wgpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/windows">windows <span class="badge">5</span></a></li>
          
            <li><a href="/tags/work">work <span class="badge">11</span></a></li>
          
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">series <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/series/fuchsia-dev">fuchsia dev <span class="badge">2</span></a></li>
          
            <li><a href="/series/modern-c&#43;&#43;">modern c&#43;&#43; <span class="badge">2</span></a></li>
          
            <li><a href="/series/rust-52-projects">rust-52-projects <span class="badge">11</span></a></li>
          
            <li><a href="/series/zeroclaw">zeroclaw <span class="badge">4</span></a></li>
          
          </ul>
        </li>
      </ul>
      <form class="navbar-form navbar-left" role="search" action="/search/" method="get">
        <div class="form-group">
          <input class="form-control" type="text" name="q" results="0" placeholder="search"/>
        </div>
        <button type="submit" class="btn btn-default">submit</button>
      </form>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/pages/about">about</a></li>
      </ul>
    </div>
  </div>
</nav>

    </div>

  <div class="row">
    <div class="col-md-9" data-pagefind-body>
          <div class="row">
      <div class="col-xs-6">
        
        <section id="prev" class="text-left">
          <a class="previous" href="https://blog.simplypatrick.com/posts/2026/02-09-wgpu-game-of-life/">
            <span class="glyphicon glyphicon-circle-arrow-left"></span>
            用 Rust &#43; WebGPU 在瀏覽器跑 Game of Life
          </a>
        </section>
        
      </div>
      <div class="col-xs-6">
        
        <section id="next" class="text-right">
          <a class="next" href="https://blog.simplypatrick.com/posts/2026/02-14-tilesplit/">
            TileSplit：用 Rust 打造保留 Ultra HDR 資訊的圖片切割工具
            <span class="glyphicon glyphicon-circle-arrow-right"></span>
          </a>
        </section>
        
      </div>
    </div>
      <h2 class="post-title">Rust Proc Macro：builder-derive 實戰</h2>
      <div class="post-meta">
        <span class="post-date">February 13, 2026</span>
        
        <a href="/categories/programming"><span class="label label-info">programming</span></a>
        
        
        <a href="/tags/rust"><span class="label label-primary">rust</span></a>
        
        <a href="/tags/proc-macro"><span class="label label-primary">proc-macro</span></a>
        
        <a href="/tags/derive"><span class="label label-primary">derive</span></a>
        
        <a href="/tags/builder"><span class="label label-primary">builder</span></a>
        
        <a href="/tags/ai-assisted"><span class="label label-primary">ai-assisted</span></a>
        
        <a href="/tags/codex"><span class="label label-primary">codex</span></a>
        
        
<div>
  
  <hr/>
  <p>
    <a href="" id="series"></a>
    這篇文章屬於 <b>rust-52-projects</b> 系列:
  </p>

  
  
  <ul class="series">
  
    <li>Feb 18, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-18-media-metadata-explorer/">Rust 媒體元資料探索器：用 FFmpeg 剖析影音檔案與打造 TUI</a></li>
  
    <li>Feb 15, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-15-tilesplit-wasm/">TileSplit WASM：把 Ultra HDR 圖片切割搬到瀏覽器</a></li>
  
    <li>Feb 14, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-14-tilesplit/">TileSplit：用 Rust 打造保留 Ultra HDR 資訊的圖片切割工具</a></li>
  
    <li>Feb 13, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-13-rust-proc-macro-builder-derive/">Rust Proc Macro：builder-derive 實戰</a></li>
  
    <li>Feb 09, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-09-wgpu-game-of-life/">用 Rust &#43; WebGPU 在瀏覽器跑 Game of Life</a></li>
  
    <li>Feb 08, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-09-cargo-apk/">深入理解 cargo-apk：從 Rust 到 Android APK 的完整流程</a></li>
  
    <li>Feb 08, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-08-flashcard-app/">從間隔重複記憶卡學習 Rust 程式設計</a></li>
  
    <li>Feb 07, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-07-guitar-fretboard/">從吉他指板視覺化學習 Rust 程式設計</a></li>
  
    <li>Jan 31, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-31-gpui-calculator/">從 GPUI 計算機學習 Rust 程式設計</a></li>
  
    <li>Jan 06, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-06-rust-wasm-markdown-editor/">用 Rust 和 WebAssembly 打造即時 Markdown 編輯器</a></li>
  
    <li>Jan 03, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-03-async-job-queue/">使用 Rust 實作非同步任務佇列：系統設計與核心概念</a></li>
  
  </ul>
</div>


      </div>
      <div class="post-content">
        <img src="/posts/2026/02-13-rust-proc-macro-builder-derive/featured.svg" alt="featured.svg" class="img-responsive post-image">
  

<p>最近在看 <a href="https://github.com/p47t/rust-52-projects/tree/main/builder-derive"><code>builder-derive</code></a> 這個小專案時，會再次被 Rust 的 procedural macro 驚艷到：</p>
<p>你在程式碼裡只寫一行 <code>#[derive(Builder)]</code>，編譯器就幫你生出一整套 Builder API。</p>
<p>但它到底怎麼做到的？</p>
<p>這篇就用 <code>builder-derive</code> 的實作，從 <code>TokenStream</code> 一路追到實際生成的程式碼，拆解 Rust proc macro 的完整流程。</p>
<h2 id="先看使用端我們到底得到了什麼">先看使用端：我們到底得到了什麼</h2>
<p>先看最終使用方式：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> builder_derive::Builder;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Builder, Debug)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    username: String,
</span></span><span style="display:flex;"><span>    email: String,
</span></span><span style="display:flex;"><span>    age: Option<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    tags: Vec<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> user <span style="color:#f92672">=</span> User::builder()
</span></span><span style="display:flex;"><span>    .username(<span style="color:#e6db74">&#34;alice&#34;</span>.to_string())
</span></span><span style="display:flex;"><span>    .email(<span style="color:#e6db74">&#34;alice@example.com&#34;</span>.to_string())
</span></span><span style="display:flex;"><span>    .age(<span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>    .build()<span style="color:#f92672">?</span>;</span></span></code></pre></div>

<p>這裡我們沒有手寫 <code>UserBuilder</code>，也沒有手寫 setter、<code>build()</code>。</p>
<p><code>#[derive(Builder)]</code> 在編譯期把這些東西全部產生出來。</p>
<h2 id="proc-macro-的核心心法編譯期程式碼產生器">Proc Macro 的核心心法：編譯期程式碼產生器</h2>
<p>很多人第一次接觸 macro 會覺得它像「文字替換」。
Rust 的 procedural macro 比這個更嚴謹：</p>
<ol>
<li>編譯器把你標註 <code>derive</code> 的語法轉成 <code>TokenStream</code></li>
<li>macro crate 用 <code>syn</code> 把 token parse 成 AST（語法樹）</li>
<li>你在 AST 上做檢查與分析</li>
<li>用 <code>quote</code> 產生新的 Rust tokens 丟回編譯器</li>
<li>編譯器把這段新程式碼當成真的程式去編譯</li>
</ol>
<p><code>builder-derive</code> 的模組切分很清楚：</p>
<ul>
<li><code>src/lib.rs</code>：入口</li>
<li><code>src/parse.rs</code>：輸入合法性檢查</li>
<li><code>src/field.rs</code>：欄位型別分析</li>
<li><code>src/generate.rs</code>：程式碼生成</li>
</ul>
<h2 id="第-1-步入口函式librs">第 1 步：入口函式（lib.rs）</h2>
<p><code>builder-derive</code> 的入口非常典型：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[proc_macro_derive(Builder)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">derive_builder</span>(input: <span style="color:#a6e22e">TokenStream</span>) -&gt; <span style="color:#a6e22e">TokenStream</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> input <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_macro_input!</span>(input <span style="color:#66d9ef">as</span> DeriveInput);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> generate::impl_builder(<span style="color:#f92672">&amp;</span>input) {
</span></span><span style="display:flex;"><span>        Ok(tokens) <span style="color:#f92672">=&gt;</span> tokens.into(),
</span></span><span style="display:flex;"><span>        Err(e) <span style="color:#f92672">=&gt;</span> e.to_compile_error().into(),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>這段有三個重點：</p>
<ol>
<li><code>#[proc_macro_derive(Builder)]</code> 把這個函式註冊成 derive macro。</li>
<li><code>parse_macro_input!</code> 把原始 token 解析成 <code>syn::DeriveInput</code>。</li>
<li>發生錯誤時用 <code>to_compile_error()</code> 轉成編譯錯誤，而不是 panic。</li>
</ol>
<p>也就是說，macro 的錯誤訊息其實是你主動設計出來的 UX。</p>
<h2 id="第-2-步先擋掉不支援的型別parsers">第 2 步：先擋掉不支援的型別（parse.rs）</h2>
<p>在 <code>parse.rs</code> 裡，專案先做輸入驗證：</p>
<ul>
<li>只接受「具名欄位 struct」</li>
<li>拒絕 enum / union / tuple struct / unit struct</li>
</ul>
<p>這個設計超務實。因為 Builder 的生成邏輯依賴欄位名稱，沒有欄位名就沒辦法安全產生 setter。</p>
<p>像這段 compile-fail 測試會得到清楚錯誤：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Builder)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">MyEnum</span> {
</span></span><span style="display:flex;"><span>    Variant1,
</span></span><span style="display:flex;"><span>    Variant2,
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>錯誤訊息是：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Builder can only be derived for structs, not enums</span></span></code></pre></div>

<p><code>builder-derive</code> 這裡做得很對：把「不可能支援」的 case 儘早在編譯期擋下來，使用者不用等到 runtime 才踩雷。</p>
<h2 id="第-3-步欄位分析fieldrs">第 3 步：欄位分析（field.rs）</h2>
<p>接著是整個 macro 的關鍵資料結構 <code>FieldInfo</code>，每個欄位會被分析出：</p>
<ul>
<li>欄位名稱 <code>name</code></li>
<li>原始型別 <code>ty</code></li>
<li>是否 <code>Option&lt;T&gt;</code></li>
<li><code>Option&lt;T&gt;</code> 的內層型別 <code>T</code></li>
<li>是否 <code>Vec&lt;T&gt;</code></li>
</ul>
<h3 id="怎麼判斷-optiont">怎麼判斷 <code>Option&lt;T&gt;</code>？</h3>
<p>它用 <code>syn::Type</code> pattern matching：</p>
<ol>
<li>先確認是 <code>Type::Path</code></li>
<li>抓路徑最後一段（例如 <code>Option</code>）</li>
<li>看識別字是不是 <code>Option</code></li>
<li>若是，從 angle-bracket 參數拿出 <code>T</code></li>
</ol>
<p>這是 proc macro 最常見也最實用的技巧：
<strong>不要自己 parse 字串；直接操作 AST。</strong></p>
<h3 id="syn-到底在做什麼"><code>syn</code> 到底在做什麼？</h3>
<p>可以把 <code>syn</code> 想成「Rust 語法的解析器 + AST 資料模型」。</p>
<p>在 <code>builder-derive</code> 裡，<code>syn</code> 主要做三件事：</p>
<ol>
<li>把 <code>TokenStream</code> 轉成 <code>DeriveInput</code>（看到 struct 名稱、可見性、欄位）</li>
<li>用 enum pattern matching 檢查資料型別（<code>Data::Struct</code> / <code>Fields::Named</code>）</li>
<li>深入欄位型別結構（<code>Type::Path</code> -&gt; <code>PathSegment</code> -&gt; <code>PathArguments</code>）判斷 <code>Option&lt;T&gt;</code>、<code>Vec&lt;T&gt;</code></li>
</ol>
<p>為什麼這很重要？因為 procedural macro 要的是「語法結構」，不是字串比對。</p>
<p>舉例來說，<code>Option&lt;String&gt;</code>、<code>std::option::Option&lt;String&gt;</code> 在字串上看起來不同，但在 AST 層都能被一致處理。這就是 <code>syn</code> 在 macro 裡的核心價值。</p>
<p>另外像 <code>syn::Error::new_spanned(...)</code> 也很關鍵：它可以把錯誤綁在原始程式碼 span 上，讓編譯錯誤直接指到真正寫錯的那一行。</p>
<h3 id="這個專案一個值得注意的設計">這個專案一個值得注意的設計</h3>
<p>對 <code>Option&lt;T&gt;</code> 欄位，setter 參數型別是 <code>T</code>，不是 <code>Option&lt;T&gt;</code>。</p>
<p>也就是你寫：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>.age(<span style="color:#ae81ff">30</span>)</span></span></code></pre></div>

<p>而不是：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>.age(Some(<span style="color:#ae81ff">30</span>))</span></span></code></pre></div>

<p>這讓 API 更順手。不過 tradeoff 是：目前 API 不能顯式設定 <code>None</code>，只能「不呼叫 setter」來得到 <code>None</code>。</p>
<h2 id="第-4-步用-quote-生成程式碼generaters">第 4 步：用 quote 生成程式碼（generate.rs）</h2>
<p><code>generate.rs</code> 裡把生成工作拆成四塊，這個切法很值得學：</p>
<ol>
<li><code>generate_builder_struct</code></li>
<li><code>generate_builder_constructor</code></li>
<li><code>generate_setter_methods</code></li>
<li><code>generate_build_method</code></li>
</ol>
<h3 id="quote-怎麼把-ast-變回-rust-程式"><code>quote!</code> 怎麼把 AST 變回 Rust 程式？</h3>
<p><code>quote</code> 的角色是「把分析結果重新組裝成 token」。</p>
<p>在這個專案裡，最常用的語法有兩個：</p>
<ol>
<li><code>#var</code>：把變數插進模板</li>
<li><code>#(...)*</code>：把 iterator 產生的多段程式碼展開</li>
</ol>
<p>例如：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> builder_fields <span style="color:#f92672">=</span> field_infos.iter().map(<span style="color:#f92672">|</span>field<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> name <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>field.name;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> builder_ty <span style="color:#f92672">=</span> field.builder_field_type();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">quote!</span> { #name: #builder_ty }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">quote!</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> #builder_name {
</span></span><span style="display:flex;"><span>        #(#builder_fields,)<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>這段可以讀成：「每個欄位先變成一小段 token，最後用 repetition 一次展開成完整 struct 欄位列表。」</p>
<p>也因為這種寫法，macro 可以維持很強的可組合性：</p>
<ul>
<li>每個生成函式只負責一種片段</li>
<li>最後在 <code>impl_builder</code> 把片段拼回完整輸出</li>
</ul>
<p>對大型 macro 專案來說，這比單一巨大 <code>quote!</code> 區塊更容易維護。</p>
<h3 id="41-生成-builder-struct">4.1 生成 Builder struct</h3>
<p>每個 builder 欄位都用 <code>Option&lt;...&gt;</code> 包起來，目的是追蹤「這個欄位有沒有被設定」。</p>
<h3 id="42-生成-builder">4.2 生成 <code>builder()</code></h3>
<p>在原始 struct 上加：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> User {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">builder</span>() -&gt; <span style="color:#a6e22e">UserBuilder</span> { <span style="color:#f92672">..</span>. }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>所有欄位初始化成 <code>None</code>。</p>
<h3 id="43-生成-setter可-chain">4.3 生成 setter（可 chain）</h3>
<p>每個 setter 都是這個形狀：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">field</span>(<span style="color:#66d9ef">mut</span> self, value: <span style="color:#a6e22e">T</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>    self.field <span style="color:#f92672">=</span> Some(value);
</span></span><span style="display:flex;"><span>    self
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><code>self</code> by value + 回傳 <code>Self</code>，就是 fluent API 的來源。</p>
<h3 id="44-生成-build而且不同欄位策略不同">4.4 生成 <code>build()</code>，而且不同欄位策略不同</h3>
<p><code>builder-derive</code> 在這裡把欄位分三類處理：</p>
<ol>
<li><code>Option&lt;T&gt;</code>：直接 passthrough（沒設就 <code>None</code>）</li>
<li><code>Vec&lt;T&gt;</code>：沒設就 <code>unwrap_or_default()</code>，變空陣列</li>
<li>其他欄位：必填，沒設就回 <code>Err(&quot;field is required&quot;)</code></li>
</ol>
<p>這個策略很實用，因為 <code>Vec&lt;T&gt;</code> 在很多 config 型別裡確實適合預設空集合。</p>
<h2 id="展開後大概長怎樣">展開後大概長怎樣？</h2>
<p>以這個輸入：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Builder)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Config</span> {
</span></span><span style="display:flex;"><span>    host: String,
</span></span><span style="display:flex;"><span>    port: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>    timeout: Option<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u64</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    features: Vec<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>macro 會產生近似這樣的程式碼（簡化版）：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ConfigBuilder</span> {
</span></span><span style="display:flex;"><span>    host: Option<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    port: Option<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u16</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    timeout: Option<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u64</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    features: Option<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Config {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">builder</span>() -&gt; <span style="color:#a6e22e">ConfigBuilder</span> {
</span></span><span style="display:flex;"><span>        ConfigBuilder {
</span></span><span style="display:flex;"><span>            host: None,
</span></span><span style="display:flex;"><span>            port: None,
</span></span><span style="display:flex;"><span>            timeout: None,
</span></span><span style="display:flex;"><span>            features: None,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> ConfigBuilder {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">host</span>(<span style="color:#66d9ef">mut</span> self, value: String) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        self.host <span style="color:#f92672">=</span> Some(value);
</span></span><span style="display:flex;"><span>        self
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">port</span>(<span style="color:#66d9ef">mut</span> self, value: <span style="color:#66d9ef">u16</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        self.port <span style="color:#f92672">=</span> Some(value);
</span></span><span style="display:flex;"><span>        self
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">timeout</span>(<span style="color:#66d9ef">mut</span> self, value: <span style="color:#66d9ef">u64</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        self.timeout <span style="color:#f92672">=</span> Some(value);
</span></span><span style="display:flex;"><span>        self
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">features</span>(<span style="color:#66d9ef">mut</span> self, value: Vec<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        self.features <span style="color:#f92672">=</span> Some(value);
</span></span><span style="display:flex;"><span>        self
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">build</span>(self) -&gt; Result<span style="color:#f92672">&lt;</span>Config, String<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        Ok(Config {
</span></span><span style="display:flex;"><span>            host: <span style="color:#a6e22e">self</span>.host.ok_or_else(<span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;host is required&#34;</span>.to_string())<span style="color:#f92672">?</span>,
</span></span><span style="display:flex;"><span>            port: <span style="color:#a6e22e">self</span>.port.ok_or_else(<span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;port is required&#34;</span>.to_string())<span style="color:#f92672">?</span>,
</span></span><span style="display:flex;"><span>            timeout: <span style="color:#a6e22e">self</span>.timeout,
</span></span><span style="display:flex;"><span>            features: <span style="color:#a6e22e">self</span>.features.unwrap_or_default(),
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p>重點是：這些都發生在編譯期，你 runtime 不需要額外 macro 成本。</p>
<h2 id="錯誤處理compile-time-跟-runtime-分工">錯誤處理：compile-time 跟 runtime 分工</h2>
<p>這個專案的錯誤策略很清楚：</p>
<h3 id="compile-timemacro-階段">Compile-time（macro 階段）</h3>
<ul>
<li>型別不支援就直接編譯失敗</li>
<li>錯誤訊息會標到對應程式碼位置（透過 <code>syn::Error::new_spanned</code>）</li>
</ul>
<h3 id="runtimebuild-階段">Runtime（build 階段）</h3>
<ul>
<li>缺必要欄位時，<code>build()</code> 回 <code>Result::Err(String)</code></li>
</ul>
<p>這種分工很合理：</p>
<ul>
<li>能在語法層判斷的，就盡量提早失敗</li>
<li>必須等使用者呼叫流程才能判斷的，就用 <code>Result</code> 回報</li>
</ul>
<h2 id="為什麼這個範例很適合學-proc-macro">為什麼這個範例很適合學 proc macro</h2>
<p><code>builder-derive</code> 的好處是它「剛好夠真實，但不會太重」：</p>
<ol>
<li>有完整 pipeline（parse -&gt; analyze -&gt; generate）</li>
<li>有 compile-fail test（<code>trybuild</code>）</li>
<li>有 integration tests 驗證行為</li>
<li>邏輯分層乾淨，不會全部擠在一個檔案</li>
</ol>
<p>如果正要開始學 proc macro，建議順序是：</p>
<ol>
<li>先看 <code>src/lib.rs</code> 入口</li>
<li>再看 <code>parse.rs</code> 怎麼做輸入保護</li>
<li>再看 <code>field.rs</code> 怎麼做型別判斷</li>
<li>最後看 <code>generate.rs</code> 的 <code>quote!</code> 拼裝</li>
</ol>
<p>這樣你比較不會一開始就被 <code>quote!</code> 的 token interpolation 淹沒。</p>
<h2 id="目前限制與下一步">目前限制與下一步</h2>
<p>以目前實作來看，還有幾個可以進化的方向：</p>
<ol>
<li>支援 generics（例如 <code>struct Foo&lt;T&gt;</code>）</li>
<li>支援 <code>#[builder(...)]</code> 欄位屬性（default、setter(into)、skip）</li>
<li>更結構化的錯誤型別（取代 <code>String</code>）</li>
<li>允許 optional setter 傳 <code>Option&lt;T&gt;</code>（可顯式設 <code>None</code>）</li>
</ol>
<p>但以「教學用、理解 proc macro 原理」來說，現在這個版本其實已經很漂亮了。</p>
<h2 id="結語">結語</h2>
<p>Rust 的 procedural macro 真正厲害的地方，不是語法炫技，而是把重複樣板在「編譯期」變成可驗證、可維護的程式碼生成流程。</p>
<p><code>builder-derive</code> 這個專案剛好把這件事示範得很清楚：</p>
<ul>
<li>用 <code>syn</code> 看懂你的 Rust 程式</li>
<li>用 <code>quote</code> 生成你本來不想手寫的 boilerplate</li>
<li>用型別檢查和測試把 macro 行為收斂到可預期</li>
</ul>
<p>下次看到 <code>#[derive(...)]</code>，你可以把它想成：
<strong>「這不是魔法，是一個在編譯器裡跑的小型 code generator。」</strong></p>
<hr>
<p>專案連結：<a href="https://github.com/p47t/rust-52-projects/tree/main/builder-derive"><code>rust-52-projects/builder-derive</code></a></p>
      </div>

      <hr>
      <script src="https://utteranc.es/client.js"
        repo="p47t/p47t.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


    </div>
    <div class="col-md-3">
      <aside class="toc">
        






<nav id="toc" data-toggle="toc">
  
  <ul class="nav">
  </ul>
</nav>

      </aside>
    </div>
  </div>
    </div>

    <div class="row">
    <div class="col-md-12">
      <footer id="footer" class="text-center">
        © Patrick Tsai 2003-2026.
        Proudly powered by <a href="http://gohugo.io/">Hugo</a>.
      </footer>
    </div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="/js/bootstrap-toc.min.js"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73968064-1', 'auto');
  ga('send', 'pageview');

</script>


  <script src="/js/prism.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true });
  </script>

</body>
</html>
