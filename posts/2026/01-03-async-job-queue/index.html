<!doctype html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <title>使用 Rust 實作非同步任務佇列：系統設計與核心概念</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

  <meta property="og:site_name" content="Simply Patrick"/>
  <meta property="og:url" content="https://blog.simplypatrick.com/posts/2026/01-03-async-job-queue/"/>
  <meta property="og:type" content="website"/>
  <meta property="og:image" content="https://lh3.googleusercontent.com/-GqbL2_hPq9Y/UC9brHyHa1I/AAAAAAAAEoY/rGGtCNWe3Vw/s800/patrick.jpg"/>

  <link rel="preload" href="/fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/Julee-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/JustMeAgainDownHere-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/SourceCodePro-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="/fonts/NotoSansTC-Regular.ttf" as="font" type="font/ttf" crossorigin>
<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/bootstrap-toc.css" rel="stylesheet">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<link href="/css/prism.css" rel="stylesheet" />
<link href="/css/blog.css" rel="stylesheet">

<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon" />

  <meta property="og:site_name" content="Simply Patrick"/>
  <meta property="og:url" content="https://blog.simplypatrick.com/posts/2026/01-03-async-job-queue/"/>
  <meta property="og:title" content="使用 Rust 實作非同步任務佇列：系統設計與核心概念"/>
  <meta property="og:type" content="article"/>
  <meta property="og:article:published_time" content="2026-01-03 15:12:56 -0800 -0800"/>
  
  <meta property="og:article:tag" content="rust"/>
  
  <meta property="og:article:tag" content="ai-assisted"/>
  
  <meta property="og:article:author" content="Patrick Tsai"/>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container" id="main">
    <div class="row">
      <header role="banner">
  <div class="row">
    <div class="col-md-9">
      <h1 class="banner-title">
        <a href="/">Simply Patrick</a>
        <small class="banner-subtitle">Hopes can always go up, tears can only come down.</small>
      </h1>
    </div>
    <div class="col-md-3 text-right">
      <ul class="social-links list-inline">
        <li><a href="https://twitter.com/PatrickSimply"><i class="fa fa-twitter"></i></a></li>
        <li><a href="https://www.facebook.com/yinghau76"><i class="fa fa-facebook"></i></a></li>
        <li><a href="https://www.linkedin.com/in/yinghau76"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/p47t"><i class="fa fa-github-alt"></i></a></li>
      </ul>
    </div>
  <div>
</header>

      <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/posts/">posts</a>
      <a class="navbar-brand" href="/tils/">TILs</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">categories <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/categories/ai">ai <span class="badge">1</span></a></li>
          
            <li><a href="/categories/ai-assisted">ai-assisted <span class="badge">2</span></a></li>
          
            <li><a href="/categories/blog">blog <span class="badge">3</span></a></li>
          
            <li><a href="/categories/business">business <span class="badge">26</span></a></li>
          
            <li><a href="/categories/career">career <span class="badge">20</span></a></li>
          
            <li><a href="/categories/claude-code">claude-code <span class="badge">1</span></a></li>
          
            <li><a href="/categories/development">development <span class="badge">52</span></a></li>
          
            <li><a href="/categories/ffi">ffi <span class="badge">1</span></a></li>
          
            <li><a href="/categories/game">game <span class="badge">3</span></a></li>
          
            <li><a href="/categories/programming">programming <span class="badge">205</span></a></li>
          
            <li><a href="/categories/rust">rust <span class="badge">1</span></a></li>
          
            <li><a href="/categories/web">web <span class="badge">10</span></a></li>
          
            <li><a href="/categories/%e7%a1%ac%e9%ab%94">硬體 <span class="badge">1</span></a></li>
          
            <li><a href="/categories/%e9%96%8b%e7%99%bc%e5%b7%a5%e5%85%b7">開發工具 <span class="badge">1</span></a></li>
          
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">tags <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/tags/agent">agent <span class="badge">4</span></a></li>
          
            <li><a href="/tags/agile">agile <span class="badge">4</span></a></li>
          
            <li><a href="/tags/ai">ai <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ai-assisted">ai-assisted <span class="badge">13</span></a></li>
          
            <li><a href="/tags/android">android <span class="badge">14</span></a></li>
          
            <li><a href="/tags/async">async <span class="badge">2</span></a></li>
          
            <li><a href="/tags/audio">audio <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ble">ble <span class="badge">1</span></a></li>
          
            <li><a href="/tags/book">book <span class="badge">25</span></a></li>
          
            <li><a href="/tags/build">build <span class="badge">4</span></a></li>
          
            <li><a href="/tags/build-tools">build-tools <span class="badge">1</span></a></li>
          
            <li><a href="/tags/builder">builder <span class="badge">1</span></a></li>
          
            <li><a href="/tags/c&#43;&#43;">c&#43;&#43; <span class="badge">8</span></a></li>
          
            <li><a href="/tags/cargo-apk">cargo-apk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/claude">claude <span class="badge">1</span></a></li>
          
            <li><a href="/tags/claude-code">claude-code <span class="badge">4</span></a></li>
          
            <li><a href="/tags/cli">cli <span class="badge">2</span></a></li>
          
            <li><a href="/tags/cloud">cloud <span class="badge">1</span></a></li>
          
            <li><a href="/tags/codex">codex <span class="badge">1</span></a></li>
          
            <li><a href="/tags/crack">crack <span class="badge">2</span></a></li>
          
            <li><a href="/tags/derive">derive <span class="badge">1</span></a></li>
          
            <li><a href="/tags/design-patterns">design-patterns <span class="badge">4</span></a></li>
          
            <li><a href="/tags/dotnet">dotnet <span class="badge">42</span></a></li>
          
            <li><a href="/tags/dsp">dsp <span class="badge">1</span></a></li>
          
            <li><a href="/tags/embedded">embedded <span class="badge">5</span></a></li>
          
            <li><a href="/tags/engineer">engineer <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ffi">ffi <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ffmpeg">ffmpeg <span class="badge">1</span></a></li>
          
            <li><a href="/tags/font">font <span class="badge">3</span></a></li>
          
            <li><a href="/tags/fuchsia">fuchsia <span class="badge">2</span></a></li>
          
            <li><a href="/tags/futures">futures <span class="badge">2</span></a></li>
          
            <li><a href="/tags/game">game <span class="badge">2</span></a></li>
          
            <li><a href="/tags/git">git <span class="badge">5</span></a></li>
          
            <li><a href="/tags/go">go <span class="badge">5</span></a></li>
          
            <li><a href="/tags/google">google <span class="badge">5</span></a></li>
          
            <li><a href="/tags/gpu">gpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/gpui">gpui <span class="badge">2</span></a></li>
          
            <li><a href="/tags/gradle">gradle <span class="badge">1</span></a></li>
          
            <li><a href="/tags/gui">gui <span class="badge">4</span></a></li>
          
            <li><a href="/tags/hdr">hdr <span class="badge">1</span></a></li>
          
            <li><a href="/tags/iced">iced <span class="badge">2</span></a></li>
          
            <li><a href="/tags/image-processing">image-processing <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ios">ios <span class="badge">6</span></a></li>
          
            <li><a href="/tags/java">java <span class="badge">9</span></a></li>
          
            <li><a href="/tags/jpeg">jpeg <span class="badge">1</span></a></li>
          
            <li><a href="/tags/jupyter">jupyter <span class="badge">1</span></a></li>
          
            <li><a href="/tags/keyboard">keyboard <span class="badge">1</span></a></li>
          
            <li><a href="/tags/kotlin">kotlin <span class="badge">2</span></a></li>
          
            <li><a href="/tags/kuso">kuso <span class="badge">3</span></a></li>
          
            <li><a href="/tags/management">management <span class="badge">3</span></a></li>
          
            <li><a href="/tags/markdown">markdown <span class="badge">1</span></a></li>
          
            <li><a href="/tags/mechanical-keyboard">mechanical-keyboard <span class="badge">1</span></a></li>
          
            <li><a href="/tags/microsoft">microsoft <span class="badge">14</span></a></li>
          
            <li><a href="/tags/ndk">ndk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/octopress">octopress <span class="badge">3</span></a></li>
          
            <li><a href="/tags/ortholinear">ortholinear <span class="badge">1</span></a></li>
          
            <li><a href="/tags/osx">osx <span class="badge">4</span></a></li>
          
            <li><a href="/tags/parser">parser <span class="badge">1</span></a></li>
          
            <li><a href="/tags/patterns">patterns <span class="badge">4</span></a></li>
          
            <li><a href="/tags/peacock">peacock <span class="badge">1</span></a></li>
          
            <li><a href="/tags/proc-macro">proc-macro <span class="badge">1</span></a></li>
          
            <li><a href="/tags/process">process <span class="badge">2</span></a></li>
          
            <li><a href="/tags/productivity">productivity <span class="badge">1</span></a></li>
          
            <li><a href="/tags/qmk">qmk <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ruby">ruby <span class="badge">15</span></a></li>
          
            <li><a href="/tags/rust">rust <span class="badge">23</span></a></li>
          
            <li><a href="/tags/scala">scala <span class="badge">3</span></a></li>
          
            <li><a href="/tags/shader">shader <span class="badge">1</span></a></li>
          
            <li><a href="/tags/slint">slint <span class="badge">1</span></a></li>
          
            <li><a href="/tags/spaced-repetition">spaced-repetition <span class="badge">1</span></a></li>
          
            <li><a href="/tags/startup">startup <span class="badge">3</span></a></li>
          
            <li><a href="/tags/swift">swift <span class="badge">1</span></a></li>
          
            <li><a href="/tags/traits">traits <span class="badge">1</span></a></li>
          
            <li><a href="/tags/tui">tui <span class="badge">1</span></a></li>
          
            <li><a href="/tags/ultrahdr">ultrahdr <span class="badge">2</span></a></li>
          
            <li><a href="/tags/vcs">vcs <span class="badge">3</span></a></li>
          
            <li><a href="/tags/vibe-coding">vibe-coding <span class="badge">1</span></a></li>
          
            <li><a href="/tags/vscode">vscode <span class="badge">1</span></a></li>
          
            <li><a href="/tags/wasm">wasm <span class="badge">5</span></a></li>
          
            <li><a href="/tags/web">web <span class="badge">3</span></a></li>
          
            <li><a href="/tags/webassembly">webassembly <span class="badge">3</span></a></li>
          
            <li><a href="/tags/webgpu">webgpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/webkit">webkit <span class="badge">3</span></a></li>
          
            <li><a href="/tags/wgpu">wgpu <span class="badge">1</span></a></li>
          
            <li><a href="/tags/windows">windows <span class="badge">5</span></a></li>
          
            <li><a href="/tags/work">work <span class="badge">11</span></a></li>
          
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">series <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/series/fuchsia-dev">fuchsia dev <span class="badge">2</span></a></li>
          
            <li><a href="/series/modern-c&#43;&#43;">modern c&#43;&#43; <span class="badge">2</span></a></li>
          
            <li><a href="/series/rust-52-projects">rust-52-projects <span class="badge">11</span></a></li>
          
            <li><a href="/series/zeroclaw">zeroclaw <span class="badge">4</span></a></li>
          
          </ul>
        </li>
      </ul>
      <form class="navbar-form navbar-left" role="search" action="/search/" method="get">
        <div class="form-group">
          <input class="form-control" type="text" name="q" results="0" placeholder="search"/>
        </div>
        <button type="submit" class="btn btn-default">submit</button>
      </form>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/pages/about">about</a></li>
      </ul>
    </div>
  </div>
</nav>

    </div>

  <div class="row">
    <div class="col-md-9" data-pagefind-body>
          <div class="row">
      <div class="col-xs-6">
        
        <section id="prev" class="text-left">
          <a class="previous" href="https://blog.simplypatrick.com/posts/2025/12-39-ai-coding/">
            <span class="glyphicon glyphicon-circle-arrow-left"></span>
            The future of AI coding
          </a>
        </section>
        
      </div>
      <div class="col-xs-6">
        
        <section id="next" class="text-right">
          <a class="next" href="https://blog.simplypatrick.com/posts/2026/01-04-vscode-peacock-colors/">
            我的 VSCode Peacock 配色收藏
            <span class="glyphicon glyphicon-circle-arrow-right"></span>
          </a>
        </section>
        
      </div>
    </div>
      <h2 class="post-title">使用 Rust 實作非同步任務佇列：系統設計與核心概念</h2>
      <div class="post-meta">
        <span class="post-date">January 3, 2026</span>
        
        <a href="/categories/programming"><span class="label label-info">programming</span></a>
        
        
        <a href="/tags/rust"><span class="label label-primary">rust</span></a>
        
        <a href="/tags/ai-assisted"><span class="label label-primary">ai-assisted</span></a>
        
        
<div>
  
  <hr/>
  <p>
    <a href="" id="series"></a>
    這篇文章屬於 <b>rust-52-projects</b> 系列:
  </p>

  
  
  <ul class="series">
  
    <li>Feb 18, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-18-media-metadata-explorer/">Rust 媒體元資料探索器：用 FFmpeg 剖析影音檔案與打造 TUI</a></li>
  
    <li>Feb 15, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-15-tilesplit-wasm/">TileSplit WASM：把 Ultra HDR 圖片切割搬到瀏覽器</a></li>
  
    <li>Feb 14, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-14-tilesplit/">TileSplit：用 Rust 打造保留 Ultra HDR 資訊的圖片切割工具</a></li>
  
    <li>Feb 13, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-13-rust-proc-macro-builder-derive/">Rust Proc Macro：builder-derive 實戰</a></li>
  
    <li>Feb 09, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-09-wgpu-game-of-life/">用 Rust &#43; WebGPU 在瀏覽器跑 Game of Life</a></li>
  
    <li>Feb 08, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-09-cargo-apk/">深入理解 cargo-apk：從 Rust 到 Android APK 的完整流程</a></li>
  
    <li>Feb 08, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-08-flashcard-app/">從間隔重複記憶卡學習 Rust 程式設計</a></li>
  
    <li>Feb 07, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/02-07-guitar-fretboard/">從吉他指板視覺化學習 Rust 程式設計</a></li>
  
    <li>Jan 31, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-31-gpui-calculator/">從 GPUI 計算機學習 Rust 程式設計</a></li>
  
    <li>Jan 06, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-06-rust-wasm-markdown-editor/">用 Rust 和 WebAssembly 打造即時 Markdown 編輯器</a></li>
  
    <li>Jan 03, 2026 - <a href="https://blog.simplypatrick.com/posts/2026/01-03-async-job-queue/">使用 Rust 實作非同步任務佇列：系統設計與核心概念</a></li>
  
  </ul>
</div>


      </div>
      <div class="post-content">
        

  
    <img src="/posts/2026/01-03-async-job-queue/featured.svg" alt="featured.svg" class="img-responsive post-image">
  

<h2 id="專案概述">專案概述</h2>
<p>本文將探討如何使用 Rust 實作一個生產級的非同步任務佇列系統。這個專案展示了多個重要的 Rust 概念和系統設計原則，包括：</p>
<ul>
<li>模組化設計與封裝</li>
<li>Trait 系統的應用</li>
<li>並發安全與資料競爭處理</li>
<li>非同步程式設計 (Tokio)</li>
<li>SQLite 資料持久化</li>
<li>CLI 工具設計</li>
</ul>
<p><strong>專案原始碼：</strong> <a href="https://github.com/p47t/rust-52-projects/tree/master/async-job-queue">https://github.com/p47t/rust-52-projects/tree/master/async-job-queue</a></p>
<h2 id="系統架構">系統架構</h2>
<h3 id="核心組件">核心組件</h3>
<p>我們的任務佇列系統由三個主要模組組成：</p>

  <pre tabindex="0"><code>async-job-queue/
├── src/
│   ├── job.rs        # 任務定義與狀態管理
│   ├── storage.rs    # SQLite 儲存層
│   ├── worker.rs     # 工作池與任務處理
│   ├── lib.rs        # 公開 API
│   └── bin/
│       ├── producer.rs  # 生產者 CLI
│       └── worker.rs    # 消費者 CLI</code></pre>

<h3 id="資料流程">資料流程</h3>

  <pre tabindex="0"><code>Producer (CLI) → SQLite Database ← Worker Pool (多個 workers)
                      ↓
                 [Pending Jobs]
                      ↓
                 [Running Jobs]
                      ↓
              [Completed/Failed/Dead Letter]</code></pre>

<h2 id="rust-核心概念解析">Rust 核心概念解析</h2>
<h3 id="1-模組可見性mod-vs-pub-mod">1. 模組可見性：<code>mod</code> vs <code>pub mod</code></h3>
<p><strong>問題：</strong> 如何設計乾淨的公開 API？</p>
<p>在 <code>lib.rs</code> 中，我們使用私有模組配合公開重匯出：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// 私有模組 - 隱藏內部實作細節
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> job;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> storage;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> worker;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 公開重匯出 - 只暴露需要的類型
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> job::{Job, JobHandler, JobStatus, Priority};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> storage::{Storage, StorageError};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> worker::WorkerPool;</span></span></code></pre></div>

<p><strong>優點：</strong></p>
<ul>
<li>✅ 使用者只能透過 <code>use async_job_queue::{Job, Storage}</code> 匯入</li>
<li>✅ 內部模組結構可以自由重構而不影響公開 API</li>
<li>✅ 更好的封裝性，隱藏實作細節</li>
</ul>
<p><strong>替代方案（不推薦）：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">mod</span> job;  <span style="color:#75715e">// 暴露整個模組，使用者可存取所有公開項目
</span></span></span></code></pre></div>

<h3 id="2-trait定義行為抽象">2. Trait：定義行為抽象</h3>
<p><code>JobHandler</code> trait 定義了任務處理的介面：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> JobHandler: Send <span style="color:#f92672">+</span> Sync {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">handle</span>(<span style="color:#f92672">&amp;</span>self, payload: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>]) -&gt; Result<span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">lt</span>;(), String<span style="color:#f92672">&amp;</span>gt;;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>設計考量：</strong></p>
<ul>
<li><code>Send + Sync</code>：確保可以在執行緒間安全傳遞和共享</li>
<li>接受 <code>&amp;[u8]</code> 而非具體類型：保持通用性，支援任何序列化格式</li>
<li>回傳 <code>Result&lt;(), String&gt;</code>：簡單的錯誤處理</li>
</ul>
<p><strong>使用範例：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">EchoHandler</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> JobHandler <span style="color:#66d9ef">for</span> EchoHandler {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">handle</span>(<span style="color:#f92672">&amp;</span>self, payload: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>]) -&gt; Result<span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">lt</span>;(), String<span style="color:#f92672">&amp;</span>gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> message <span style="color:#f92672">=</span> String::from_utf8_lossy(payload);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;處理任務：</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, message);
</span></span><span style="display:flex;"><span>        Ok(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<h3 id="3-newtype-模式的應用場景">3. Newtype 模式的應用場景</h3>
<p><strong>討論：</strong> 應該使用 <code>Vec&lt;u8&gt;</code> 還是 <code>JobPayload</code> 新類型？</p>
<p><strong>目前實作（<code>Vec&lt;u8&gt;</code>）：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Job</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> payload: Vec<span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">lt</span>;<span style="color:#66d9ef">u8</span><span style="color:#f92672">&amp;</span>gt;,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>Newtype 模式：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">JobPayload</span>(Vec<span style="color:#f92672">&amp;</span>lt;<span style="color:#66d9ef">u8</span><span style="color:#f92672">&amp;</span>gt;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> JobPayload {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>(bytes: Vec<span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">lt</span>;<span style="color:#66d9ef">u8</span><span style="color:#f92672">&amp;</span>gt;) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        Self(bytes)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">as_bytes</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>] {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>self.<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> From<span style="color:#f92672">&amp;</span>lt;String<span style="color:#f92672">&amp;</span>gt; <span style="color:#66d9ef">for</span> JobPayload {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from</span>(s: String) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        Self(s.into_bytes())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>何時使用 Newtype：</strong></p>
<ul>
<li>✅ 提供型別安全（避免混淆不同的 <code>Vec&lt;u8&gt;</code>）</li>
<li>✅ 零成本抽象（編譯時展開，無執行時開銷）</li>
<li>✅ API 更清晰（<code>Job::new(JobPayload, ...)</code> vs <code>Job::new(Vec&lt;u8&gt;, ...)</code>）</li>
<li>✅ 未來擴充性（可加入驗證、壓縮等功能）</li>
</ul>
<p><strong>目前專案的選擇：</strong>
保持 <code>Vec&lt;u8&gt;</code> 是合理的，因為：</p>
<ul>
<li>系統設計為通用型，不關心具體格式</li>
<li>API 介面簡單，不易混淆</li>
<li>遵循 YAGNI 原則（You Aren&rsquo;t Gonna Need It）</li>
</ul>
<h3 id="4-列舉型別與-display-trait">4. 列舉型別與 Display Trait</h3>
<p><strong>問題：</strong> 如何為列舉實作 <code>Display</code>？</p>
<p><strong>手動實作（目前方式）：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> fmt::Display <span style="color:#66d9ef">for</span> Priority {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fmt</span>(<span style="color:#f92672">&amp;</span>self, f: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> fmt::Formatter<span style="color:#f92672">&amp;</span>lt;&#39;_<span style="color:#f92672">&amp;</span>gt;) -&gt; <span style="color:#a6e22e">fmt</span>::Result {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Priority::Low <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">write!</span>(f, <span style="color:#e6db74">&#34;low&#34;</span>),
</span></span><span style="display:flex;"><span>            Priority::Normal <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">write!</span>(f, <span style="color:#e6db74">&#34;normal&#34;</span>),
</span></span><span style="display:flex;"><span>            Priority::High <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">write!</span>(f, <span style="color:#e6db74">&#34;high&#34;</span>),
</span></span><span style="display:flex;"><span>            Priority::Critical <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">write!</span>(f, <span style="color:#e6db74">&#34;critical&#34;</span>),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>使用第三方 crate（<code>strum</code>）：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> strum_macros::Display;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Display)]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[strum(serialize_all = </span><span style="color:#e6db74">&#34;lowercase&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Priority</span> {
</span></span><span style="display:flex;"><span>    Low,
</span></span><span style="display:flex;"><span>    Normal,
</span></span><span style="display:flex;"><span>    High,
</span></span><span style="display:flex;"><span>    Critical,
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>建議：</strong> 對於簡單列舉，手動實作更清晰，無需額外依賴。</p>
<h3 id="5-非同步程式設計tokio-的角色">5. 非同步程式設計：Tokio 的角色</h3>
<p><strong>Tokio 在專案中的使用：</strong></p>
<ol>
<li><strong><code>#[tokio::main]</code></strong> - 設定非同步執行環境</li>
</ol>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">lt</span>;(), Box<span style="color:#f92672">&amp;</span>lt;<span style="color:#66d9ef">dyn</span> std::error::Error<span style="color:#f92672">&amp;</span>gt;<span style="color:#f92672">&amp;</span>gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<ol start="2">
<li><strong><code>tokio::spawn</code></strong> - 並發執行多個 worker</li>
</ol>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> worker_id <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>self.num_workers {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> handle <span style="color:#f92672">=</span> tokio::spawn(<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
</span></span><span style="display:flex;"><span>        worker_loop(worker_id, storage, handler, poll_interval).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    handles.push(handle);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<ol start="3">
<li><strong><code>tokio::time::sleep</code></strong> - 非阻塞延遲</li>
</ol>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>sleep(poll_interval).<span style="color:#66d9ef">await</span>;  <span style="color:#75715e">// 輪詢間隔
</span></span></span></code></pre></div>

<p><strong>有趣的觀察：</strong>
這個專案實際上是「假非同步」！核心操作都是同步的：</p>
<ul>
<li>SQLite 操作使用 <code>rusqlite</code>（同步 API）</li>
<li>任務處理是同步函式</li>
<li>使用 <code>std::sync::Mutex</code> 而非 <code>tokio::sync::Mutex</code></li>
</ul>
<p><strong>為什麼還要用 Tokio？</strong></p>
<ul>
<li>方便建立並發 worker（比 <code>std::thread</code> 更輕量）</li>
<li>非阻塞的 sleep（不會凍結整個執行緒）</li>
<li>為未來的非同步擴充做準備</li>
</ul>
<h3 id="6-stdsyncmutex-vs-tokiosyncmutex">6. <code>std::sync::Mutex</code> vs <code>tokio::sync::Mutex</code></h3>
<p><strong>關鍵差異：</strong></p>
<table>
  <thead>
      <tr>
          <th>特性</th>
          <th><code>std::sync::Mutex</code></th>
          <th><code>tokio::sync::Mutex</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>等待鎖時</td>
          <td>阻塞整個執行緒</td>
          <td>讓出執行權給其他 task</td>
      </tr>
      <tr>
          <td>使用方式</td>
          <td><code>mutex.lock().unwrap()</code></td>
          <td><code>mutex.lock().await</code></td>
      </tr>
      <tr>
          <td>適用場景</td>
          <td>短時間持鎖、同步操作</td>
          <td>長時間持鎖、跨 await</td>
      </tr>
      <tr>
          <td>效能</td>
          <td>更快（作業系統級）</td>
          <td>稍慢（需協調排程）</td>
      </tr>
  </tbody>
</table>
<p><strong>目前專案的正確選擇：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Storage</span> {
</span></span><span style="display:flex;"><span>    conn: <span style="color:#a6e22e">Arc</span><span style="color:#f92672">&amp;</span>lt;Mutex<span style="color:#f92672">&amp;</span>lt;Connection<span style="color:#f92672">&amp;</span>gt;<span style="color:#f92672">&amp;</span>gt;,  <span style="color:#75715e">// ✅ std::sync::Mutex
</span></span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">get_next_pending</span>(<span style="color:#f92672">&amp;</span>self) <span style="color:#f92672">-&amp;</span>gt; Result<span style="color:#f92672">&amp;</span>lt;Option<span style="color:#f92672">&amp;</span>lt;Job<span style="color:#f92672">&amp;</span>gt;, StorageError<span style="color:#f92672">&amp;</span>gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> conn <span style="color:#f92672">=</span> self.conn.lock().unwrap();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 執行快速的同步資料庫操作
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 沒有在持鎖期間 await
</span></span></span><span style="display:flex;"><span>    Ok(job)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>何時必須使用 <code>tokio::sync::Mutex</code>：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// ❌ 錯誤：在持有 std::sync::Mutex 時 await
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> guard <span style="color:#f92672">=</span> std_mutex.lock().unwrap();
</span></span><span style="display:flex;"><span>async_operation().<span style="color:#66d9ef">await</span>;  <span style="color:#75715e">// 會阻塞整個執行緒！
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ✅ 正確：使用 tokio::sync::Mutex
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> guard <span style="color:#f92672">=</span> tokio_mutex.lock().<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>async_operation().<span style="color:#66d9ef">await</span>;  <span style="color:#75715e">// OK，會讓出執行權
</span></span></span></code></pre></div>

<h2 id="並發安全與資料競爭">並發安全與資料競爭</h2>
<h3 id="發現的競爭條件問題">發現的競爭條件問題</h3>
<p><strong>原始設計的漏洞：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// ❌ 有競爭條件的程式碼
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">get_next_pending</span>(<span style="color:#f92672">&amp;</span>self) <span style="color:#f92672">-&amp;</span>gt; Result<span style="color:#f92672">&amp;</span>lt;Option<span style="color:#f92672">&amp;</span>lt;Job<span style="color:#f92672">&amp;</span>gt;, StorageError<span style="color:#f92672">&amp;</span>gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 步驟 1：讀取待處理任務
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> job <span style="color:#f92672">=</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">..</span>. <span style="color:#66d9ef">WHERE</span> status <span style="color:#f92672">=</span> Pending <span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ⚠️ 問題：Worker 2 可能在這裡也讀取到相同任務！
</span></span></span><span style="display:flex;"><span>    Ok(job)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Worker 處理邏輯
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> job <span style="color:#f92672">=</span> storage.get_next_pending()<span style="color:#f92672">?</span>;  <span style="color:#75715e">// 取得任務
</span></span></span><span style="display:flex;"><span>job.mark_running();                     <span style="color:#75715e">// 標記為執行中
</span></span></span><span style="display:flex;"><span>storage.update(<span style="color:#f92672">&amp;</span>job)<span style="color:#f92672">?</span>;                  <span style="color:#75715e">// 更新資料庫
</span></span></span></code></pre></div>

<p><strong>時序圖展示問題：</strong></p>
<table>
  <thead>
      <tr>
          <th>時間</th>
          <th>Worker 1</th>
          <th>Worker 2</th>
          <th>資料庫狀態</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>T1</td>
          <td>get_next_pending()</td>
          <td></td>
          <td>Job A: Pending</td>
      </tr>
      <tr>
          <td>T2</td>
          <td>讀取 Job A</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>T3</td>
          <td></td>
          <td>get_next_pending()</td>
          <td>Job A: Pending</td>
      </tr>
      <tr>
          <td>T4</td>
          <td></td>
          <td>讀取 Job A (相同!)</td>
          <td></td>
      </tr>
      <tr>
          <td>T5</td>
          <td>mark_running()</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>T6</td>
          <td>update(Job A)</td>
          <td></td>
          <td>Job A: Running</td>
      </tr>
      <tr>
          <td>T7</td>
          <td></td>
          <td>mark_running()</td>
          <td></td>
      </tr>
      <tr>
          <td>T8</td>
          <td></td>
          <td>update(Job A)</td>
          <td>Job A: Running</td>
      </tr>
      <tr>
          <td>T9</td>
          <td>處理 Job A</td>
          <td>處理 Job A</td>
          <td>❌ 重複處理！</td>
      </tr>
  </tbody>
</table>
<h3 id="解決方案原子性操作">解決方案：原子性操作</h3>
<p><strong>修正後的實作：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">get_next_pending</span>(<span style="color:#f92672">&amp;</span>self) <span style="color:#f92672">-&amp;</span>gt; Result<span style="color:#f92672">&amp;</span>lt;Option<span style="color:#f92672">&amp;</span>lt;Job<span style="color:#f92672">&amp;</span>gt;, StorageError<span style="color:#f92672">&amp;</span>gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> conn <span style="color:#f92672">=</span> self.conn.lock().unwrap();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ✅ 原子性的 UPDATE + RETURNING（一個 SQL 語句完成）
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> stmt <span style="color:#f92672">=</span> conn.prepare(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;UPDATE jobs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         SET status = ?1, updated_at = ?2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         WHERE id = (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             SELECT id FROM jobs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             WHERE status = ?3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             ORDER BY priority DESC, created_at ASC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             LIMIT 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         RETURNING id, payload, priority, status, retry_count, max_retries,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                   created_at, updated_at, error_message&#34;</span>,
</span></span><span style="display:flex;"><span>    )<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> now <span style="color:#f92672">=</span> Utc::now().to_rfc3339();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> job <span style="color:#f92672">=</span> stmt
</span></span><span style="display:flex;"><span>        .query_row(
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">params!</span>[JobStatus::Running <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i32</span>, now, JobStatus::Pending <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i32</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span>row<span style="color:#f92672">|</span> Ok(self.row_to_job(row)<span style="color:#f92672">?</span>),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        .optional()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(job)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>為什麼這樣可以解決問題：</strong></p>
<ol>
<li><strong>原子性保證：</strong> <code>UPDATE ... RETURNING</code> 是單一 SQL 語句</li>
<li><strong>Mutex 保護：</strong> 同一時間只有一個 worker 能執行此查詢</li>
<li><strong>狀態立即改變：</strong> 任務在被回傳前就已標記為 Running</li>
<li><strong>資料庫層級鎖定：</strong> SQLite 的 EXCLUSIVE 鎖確保寫入安全</li>
</ol>
<p><strong>修正後的時序：</strong></p>
<table>
  <thead>
      <tr>
          <th>時間</th>
          <th>Worker 1</th>
          <th>Worker 2</th>
          <th>資料庫狀態</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>T1</td>
          <td>取得 Mutex</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>T2</td>
          <td>UPDATE Job A → Running</td>
          <td>等待 Mutex</td>
          <td>Job A: Running</td>
      </tr>
      <tr>
          <td>T3</td>
          <td>釋放 Mutex，回傳 Job A</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>T4</td>
          <td></td>
          <td>取得 Mutex</td>
          <td></td>
      </tr>
      <tr>
          <td>T5</td>
          <td></td>
          <td>UPDATE (找不到 Pending)</td>
          <td>Job A: Running</td>
      </tr>
      <tr>
          <td>T6</td>
          <td></td>
          <td>回傳 None</td>
          <td></td>
      </tr>
      <tr>
          <td>T7</td>
          <td>處理 Job A</td>
          <td>等待下一輪</td>
          <td>✅ 無重複處理</td>
      </tr>
  </tbody>
</table>
<h3 id="worker-程式碼簡化">Worker 程式碼簡化</h3>
<p>因為 <code>get_next_pending()</code> 已經原子性地標記任務，worker 程式碼更簡潔：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// ✅ 修正後
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">match</span> storage.get_next_pending() {
</span></span><span style="display:flex;"><span>    Ok(Some(<span style="color:#66d9ef">mut</span> job)) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 任務已經是 Running 狀態，直接處理
</span></span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> handler.handle(<span style="color:#f92672">&amp;</span>job.payload) {
</span></span><span style="display:flex;"><span>            Ok(()) <span style="color:#f92672">=&gt;</span> job.mark_completed(),
</span></span><span style="display:flex;"><span>            Err(e) <span style="color:#f92672">=&gt;</span> job.mark_failed(e),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        storage.update(<span style="color:#f92672">&amp;</span>job)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Ok(None) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>        sleep(poll_interval).<span style="color:#66d9ef">await</span>;  <span style="color:#75715e">// 無任務，等待
</span></span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Err(e) <span style="color:#f92672">=&gt;</span> { <span style="color:#75715e">/* 處理錯誤 */</span> }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<h2 id="日誌與除錯">日誌與除錯</h2>
<h3 id="tracing-vs-println"><code>tracing</code> vs <code>println!</code></h3>
<p><strong>何時使用 <code>println!</code>：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// ✅ 使用者導向的輸出
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;Job ID: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, job.id);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;Status: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, job.status);</span></span></code></pre></div>

<p><strong>何時使用 <code>tracing</code>：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// ✅ 操作性日誌、除錯資訊
</span></span></span><span style="display:flex;"><span>tracing::<span style="color:#a6e22e">info!</span>(job_id <span style="color:#f92672">=</span> <span style="color:#f92672">%</span>job.id, <span style="color:#e6db74">&#34;Processing job&#34;</span>);
</span></span><span style="display:flex;"><span>tracing::<span style="color:#a6e22e">error!</span>(<span style="color:#e6db74">&#34;Database error: {}&#34;</span>, e);</span></span></code></pre></div>

<p><strong>在 CLI 工具中：</strong></p>
<ul>
<li><code>producer</code> 使用 <code>println!</code> 顯示命令結果（使用者期望的輸出）</li>
<li><code>worker</code> 使用 <code>tracing</code> 記錄操作日誌（方便監控和除錯）</li>
</ul>
<h3 id="初始化-tracing">初始化 tracing</h3>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&amp;</span>gt; Result<span style="color:#f92672">&amp;</span>lt;(), Box<span style="color:#f92672">&amp;</span>lt;<span style="color:#66d9ef">dyn</span> std::error::Error<span style="color:#f92672">&amp;</span>gt;<span style="color:#f92672">&amp;</span>gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 設定日誌格式與過濾級別
</span></span></span><span style="display:flex;"><span>    tracing_subscriber::fmt()
</span></span><span style="display:flex;"><span>        .with_env_filter(
</span></span><span style="display:flex;"><span>            tracing_subscriber::EnvFilter::from_default_env()
</span></span><span style="display:flex;"><span>                .add_directive(tracing::Level::<span style="color:#66d9ef">INFO</span>.into()),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        .init();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>使用方式：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 預設 INFO 級別</span>
</span></span><span style="display:flex;"><span>./worker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定為 DEBUG 級別</span>
</span></span><span style="display:flex;"><span>RUST_LOG<span style="color:#f92672">=</span>debug ./worker</span></span></code></pre></div>

<h2 id="資料持久化設計">資料持久化設計</h2>
<h3 id="sqlite-schema">SQLite Schema</h3>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> jobs (
</span></span><span style="display:flex;"><span>    id TEXT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>    payload BLOB <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    priority INTEGER <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    status INTEGER <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    retry_count INTEGER <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    max_retries INTEGER <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    created_at TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    updated_at TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    error_message TEXT
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_status_priority
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ON</span> jobs(status, priority <span style="color:#66d9ef">DESC</span>, created_at <span style="color:#66d9ef">ASC</span>);</span></span></code></pre></div>

<p><strong>索引設計考量：</strong></p>
<ul>
<li><code>status</code> 在前：快速過濾待處理任務</li>
<li><code>priority DESC</code>：高優先順序優先</li>
<li><code>created_at ASC</code>：相同優先順序時，先進先出 (FIFO)</li>
</ul>
<h3 id="狀態轉換">狀態轉換</h3>

  <pre tabindex="0"><code>         ┌─────────────┐
         │   Pending   │
         └──────┬──────┘
                │
                ↓
         ┌──────────────┐
         │   Running    │
         └──────┬───────┘
                │
        ┌───────┴────────┐
        │                │
        ↓ (成功)          ↓ (失敗)
  ┌───────────┐    ┌─────────┐
  │ Completed │    │ Failed  │
  └───────────┘    └────┬────┘
                        │
                ┌───────┴────────┐
                │                │
                ↓ (可重試)        ↓ (超過最大重試)
           [Pending]        ┌──────────────┐
          (retry_count++)   │ DeadLetter   │
                            └──────────────┘</code></pre>

<p>失敗處理:</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">mark_failed</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, error: String) {
</span></span><span style="display:flex;"><span>    self.status <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> self.can_retry() {
</span></span><span style="display:flex;"><span>        self.retry_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        JobStatus::Pending  <span style="color:#75715e">// 重新排程
</span></span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        JobStatus::DeadLetter  <span style="color:#75715e">// 移至死信佇列
</span></span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    self.error_message <span style="color:#f92672">=</span> Some(error);
</span></span><span style="display:flex;"><span>    self.updated_at <span style="color:#f92672">=</span> Utc::now();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<h2 id="cli-設計">CLI 設計</h2>
<h3 id="producer生產者">Producer（生產者）</h3>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 提交任務</span>
</span></span><span style="display:flex;"><span>producer submit -p <span style="color:#e6db74">&#34;Hello, World!&#34;</span> -r high -m <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查詢狀態</span>
</span></span><span style="display:flex;"><span>producer status --job-id &amp;lt;uuid&amp;gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 統計資料</span>
</span></span><span style="display:flex;"><span>producer stats</span></span></code></pre></div>

<p><strong>使用 Clap 實作：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Parser)]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[command(name = </span><span style="color:#e6db74">&#34;producer&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[command(about = </span><span style="color:#e6db74">&#34;Job queue producer - submit and manage jobs&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cli</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[arg(short, long, default_value = </span><span style="color:#e6db74">&#34;jobs.db&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>    database: String,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[command(subcommand)]</span>
</span></span><span style="display:flex;"><span>    command: <span style="color:#a6e22e">Commands</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Subcommand)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Commands</span> {
</span></span><span style="display:flex;"><span>    Submit {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#[arg(short, long)]</span>
</span></span><span style="display:flex;"><span>        payload: String,
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#[arg(short = &#39;r&#39;, long, default_value = </span><span style="color:#e6db74">&#34;normal&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>        priority: String,
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#[arg(short, long, default_value = </span><span style="color:#e6db74">&#34;3&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>        max_retries: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    Status { <span style="color:#75715e">/* ... */</span> },
</span></span><span style="display:flex;"><span>    Stats,
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<h3 id="worker消費者">Worker（消費者）</h3>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 啟動 4 個 workers</span>
</span></span><span style="display:flex;"><span>worker -w <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用不同的資料庫</span>
</span></span><span style="display:flex;"><span>worker --database /path/to/jobs.db --workers <span style="color:#ae81ff">8</span></span></span></code></pre></div>

<h2 id="效能考量">效能考量</h2>
<h3 id="輪詢-vs-事件驅動">輪詢 vs 事件驅動</h3>
<p><strong>目前實作（輪詢）：</strong></p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">loop</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> storage.get_next_pending() {
</span></span><span style="display:flex;"><span>        Ok(Some(job)) <span style="color:#f92672">=&gt;</span> { <span style="color:#75715e">/* 處理 */</span> }
</span></span><span style="display:flex;"><span>        Ok(None) <span style="color:#f92672">=&gt;</span> sleep(poll_interval).<span style="color:#66d9ef">await</span>,  <span style="color:#75715e">// 等待 1 秒
</span></span></span><span style="display:flex;"><span>        Err(e) <span style="color:#f92672">=&gt;</span> { <span style="color:#75715e">/* 錯誤處理 */</span> }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>優點：</strong></p>
<ul>
<li>✅ 實作簡單</li>
<li>✅ 可靠性高（無需額外機制）</li>
<li>✅ 易於理解和維護</li>
</ul>
<p><strong>缺點：</strong></p>
<ul>
<li>❌ 延遲：最多 <code>poll_interval</code> 的延遲</li>
<li>❌ 資源浪費：無任務時仍在輪詢</li>
</ul>
<p><strong>改進方案（事件驅動）：</strong>
可以使用 <code>tokio::sync::Notify</code> 或資料庫的 NOTIFY/LISTEN：</p>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// 生產者插入任務後通知
</span></span></span><span style="display:flex;"><span>notifier.notify_waiters();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Worker 等待通知
</span></span></span><span style="display:flex;"><span>notifier.notified().<span style="color:#66d9ef">await</span>;</span></span></code></pre></div>

<h3 id="指數退避exponential-backoff">指數退避（Exponential Backoff）</h3>

  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> job.retry_count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> backoff <span style="color:#f92672">=</span> Duration::from_secs(<span style="color:#ae81ff">2_</span><span style="color:#66d9ef">u64</span>.pow(job.retry_count.min(<span style="color:#ae81ff">5</span>)));
</span></span><span style="display:flex;"><span>    sleep(backoff).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>

<p><strong>退避時間：</strong></p>
<ul>
<li>第 1 次重試：2^1 = 2 秒</li>
<li>第 2 次重試：2^2 = 4 秒</li>
<li>第 3 次重試：2^3 = 8 秒</li>
<li>第 4 次重試：2^4 = 16 秒</li>
<li>第 5 次以上：2^5 = 32 秒（最大值）</li>
</ul>
<p><strong>目的：</strong> 避免快速重試造成系統負擔，給下游服務恢復時間。</p>
<h2 id="最佳實踐總結">最佳實踐總結</h2>
<h3 id="1-模組設計">1. 模組設計</h3>
<ul>
<li>使用私有模組 + 公開重匯出控制 API</li>
<li>清晰的關注點分離</li>
</ul>
<h3 id="2-型別安全">2. 型別安全</h3>
<ul>
<li>考慮使用 newtype 模式增加型別安全</li>
<li>平衡抽象與簡潔性</li>
</ul>
<h3 id="3-並發處理">3. 並發處理</h3>
<ul>
<li>識別臨界區（critical section）</li>
<li>使用原子操作避免競爭條件</li>
<li>選擇適當的同步原語（Mutex、RwLock 等）</li>
</ul>
<h3 id="4-錯誤處理">4. 錯誤處理</h3>
<ul>
<li>使用 <code>thiserror</code> 定義清晰的錯誤類型</li>
<li>區分可恢復與不可恢復的錯誤</li>
</ul>
<h3 id="5-日誌策略">5. 日誌策略</h3>
<ul>
<li>CLI 輸出用 <code>println!</code></li>
<li>操作日誌用 <code>tracing</code></li>
<li>使用環境變數控制日誌級別</li>
</ul>
<h3 id="6-非同步選擇">6. 非同步選擇</h3>
<ul>
<li>評估是否真的需要 async/await</li>
<li>混合使用同步與非同步程式碼時要小心</li>
<li>理解 <code>std::sync</code> 與 <code>tokio::sync</code> 的差異</li>
</ul>
<h2 id="擴充方向">擴充方向</h2>
<ol>
<li>
<p><strong>真正的非同步化：</strong></p>
<ul>
<li>使用 <code>sqlx</code> 或 <code>tokio-rusqlite</code></li>
<li>非同步的 <code>JobHandler</code> trait</li>
</ul>
</li>
<li>
<p><strong>分散式支援：</strong></p>
<ul>
<li>使用 PostgreSQL 的 <code>SELECT FOR UPDATE SKIP LOCKED</code></li>
<li>Redis 作為訊息佇列</li>
</ul>
</li>
<li>
<p><strong>監控與觀測：</strong></p>
<ul>
<li>Prometheus metrics</li>
<li>分散式追蹤</li>
</ul>
</li>
<li>
<p><strong>進階功能：</strong></p>
<ul>
<li>延遲任務（scheduled jobs）</li>
<li>任務優先順序調整</li>
<li>動態 worker 擴縮容</li>
</ul>
</li>
</ol>
<h2 id="結論">結論</h2>
<p>這個專案展示了如何使用 Rust 構建可靠的系統軟體。關鍵要點：</p>
<ul>
<li><strong>型別系統</strong>讓我們在編譯期捕獲許多錯誤</li>
<li><strong>所有權模型</strong>確保記憶體安全與執行緒安全</li>
<li><strong>Trait 系統</strong>提供零成本抽象</li>
<li><strong>並發原語</strong>幫助我們正確處理競爭條件</li>
</ul>
<p>Rust 的「如果編譯通過，通常就能正確運行」的特性，讓我們能夠自信地構建複雜的並發系統。</p>

      </div>

      <hr>
      <script src="https://utteranc.es/client.js"
        repo="p47t/p47t.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


    </div>
    <div class="col-md-3">
      <aside class="toc">
        






<nav id="toc" data-toggle="toc">
  
  <ul class="nav">
  </ul>
</nav>

      </aside>
    </div>
  </div>
    </div>

    <div class="row">
    <div class="col-md-12">
      <footer id="footer" class="text-center">
        © Patrick Tsai 2003-2026.
        Proudly powered by <a href="http://gohugo.io/">Hugo</a>.
      </footer>
    </div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="/js/bootstrap-toc.min.js"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73968064-1', 'auto');
  ga('send', 'pageview');

</script>


  <script src="/js/prism.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true });
  </script>

</body>
</html>
